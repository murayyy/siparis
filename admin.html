<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Depo Otomasyonu</title>
  <style>
    body {
      background: #0f172a;
      color: #e2e8f0;
      font-family: system-ui, Arial;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    header {
      width: 100%;
      max-width: 1200px;
      background: #111827;
      padding: 16px 20px;
      border-radius: 0 0 10px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 0 12px #0005;
    }
    h1 { margin: 0; font-size: 20px; color: #93c5fd; }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 14px;
      cursor: pointer;
      font-weight: bold;
      margin: 3px;
    }
    button.success { background: #22c55e; }
    button.danger { background: #ef4444; }
    main {
      width: 100%;
      max-width: 1200px;
      padding: 20px;
    }
    .card {
      background: #1e293b;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border-bottom: 1px solid #334155;
      padding: 8px;
      text-align: left;
    }
    tr:nth-child(even) { background: #1e293b33; }
    select, input {
      background: #0f172a;
      color: #fff;
      border: 1px solid #334155;
      border-radius: 6px;
      padding: 6px 8px;
      margin: 3px;
    }
    .hidden { display: none !important; }
  </style>
</head>

<body>
  <header>
    <h1>📦 TUĞLUBEY Depo Otomasyonu</h1>
    <button id="logoutBtn" class="danger hidden">Çıkış</button>
  </header>

  <main>
    <!-- 🔑 GİRİŞ -->
    <section id="view-login">
      <h2>🔑 Giriş Yap</h2>
      <input type="email" id="login-email" placeholder="Email"/><br/>
      <input type="password" id="login-pass" placeholder="Şifre"/><br/>
      <button id="loginBtn">Giriş</button>
      <hr/>
      <h3>🆕 Yeni Kayıt</h3>
      <input type="email" id="reg-email" placeholder="Email"/><br/>
      <input type="password" id="reg-pass" placeholder="Şifre"/><br/>
      <select id="reg-role">
        <option value="sube">Şube</option>
        <option value="yonetici">Yönetici</option>
      </select><br/>
      <button id="registerBtn">Kayıt Ol</button>
      <p id="loginStatus" style="color:#38bdf8;"></p>
    </section>

    <!-- 🏪 ŞUBE PANELİ -->
    <section id="view-branch" class="hidden">
      <h2>🏪 Şube Siparişi</h2>
      <div class="card">
        <label for="branchWarehouse">Depo:</label>
        <select id="branchWarehouse">
          <option value="MERKEZ">MERKEZ</option>
          <option value="ATIŞALANI">ATIŞALANI</option>
          <option value="YEŞİLPINAR">YEŞİLPINAR</option>
          <option value="ALAŞEHİR">ALAŞEHİR</option>
          <option value="SAKARYA 2">SAKARYA 2</option>
          <option value="EMEK">EMEK</option>
        </select>
      </div>
      <div class="card">
        <h3>📥 Satır Ekle</h3>
        <div>
          <select id="branchProduct" class="input"></select>
          <input id="branchQty" class="input" type="number" placeholder="Miktar" min="1" value="1"/>
          <button id="addLineBtn">Satır Ekle</button>
        </div>
        <table id="tbl-branch-lines">
          <thead><tr><th>#</th><th>Kod</th><th>Ürün</th><th>Miktar</th><th>Sil</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="card">
        <input id="orderName" class="input" placeholder="Sipariş Adı"/>
        <button id="createOrderBtn" class="success">Siparişi Oluştur</button>
      </div>
      <div class="card">
        <h3>🧾 Siparişlerim</h3>
        <button id="refreshOrdersBtn">Yenile</button>
        <table id="branchOrders">
          <thead><tr><th>ID</th><th>Ad</th><th>Depo</th><th>Durum</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- 👨‍💼 YÖNETİCİ PANELİ -->
    <section id="view-manager" class="hidden">
      <h2>👨‍💼 Yönetici Paneli</h2>
      <div class="card">
        <div>
          <button id="refreshOrdersAdmin">🔄 Yenile</button>
          <button id="exportOrdersBtn">⬇️ Excel'e Aktar</button>
        </div>
        <table id="tbl-orders">
          <thead><tr><th>ID</th><th>Ad</th><th>Şube</th><th>Durum</th><th>İşlem</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="card">
        <h3>📊 Durum Özeti</h3>
        <p>Yeni: <span id="statYeni">0</span> | Atandı: <span id="statAtandi">0</span> | Tamamlandı: <span id="statBitti">0</span></p>
      </div>
    </section>
  </main>

  <!-- Firebase + XLSX -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/xlsx.mjs" type="module"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
    import * as XLSX from "https://cdn.sheetjs.com/xlsx-0.20.3/package/xlsx.mjs";

    const firebaseConfig = {
      apiKey: "AIzaSyDcLQB4UggXlYA9x8AKw-XybJjcF6U_KA4",
      authDomain: "depo1-4668f.firebaseapp.com",
      projectId: "depo1-4668f",
      storageBucket: "depo1-4668f.appspot.com",
      messagingSenderId: "1044254626353",
      appId: "1:1044254626353:web:148c57df2456cc3d9e3b10"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const $ = id => document.getElementById(id);

    // Login kontrolü
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        $("logoutBtn").classList.remove("hidden");
        const snap = await getDoc(doc(db, "users", user.uid));
        const role = snap.exists() ? snap.data().role : "sube";
        $("view-login").classList.add("hidden");
        if (role === "sube") $("view-branch").classList.remove("hidden");
        if (role === "yonetici") $("view-manager").classList.remove("hidden");
        loadOrders();
      } else {
        $("view-login").classList.remove("hidden");
        $("view-branch").classList.add("hidden");
        $("view-manager").classList.add("hidden");
        $("logoutBtn").classList.add("hidden");
      }
    });

    // Giriş
    $("loginBtn").addEventListener("click", async ()=>{
      try { await signInWithEmailAndPassword(auth, $("login-email").value, $("login-pass").value); }
      catch(e){ $("loginStatus").textContent = "Hata: "+e.message; }
    });

    // Kayıt
    $("registerBtn").addEventListener("click", async ()=>{
      try {
        const cred = await createUserWithEmailAndPassword(auth, $("reg-email").value, $("reg-pass").value);
        await setDoc(doc(db, "users", cred.user.uid), { email: $("reg-email").value, role: $("reg-role").value });
        $("loginStatus").textContent = "Kayıt başarılı! Giriş yapabilirsiniz.";
      } catch(e){ $("loginStatus").textContent = "Hata: "+e.message; }
    });

    // Çıkış
    $("logoutBtn").addEventListener("click", ()=>signOut(auth));

    // Ürün yükleme
    async function loadProducts() {
      const q = await getDocs(collection(db, "products"));
      const sel = $("branchProduct");
      sel.innerHTML = "";
      q.forEach(docSnap=>{
        const p = docSnap.data();
        const opt = document.createElement("option");
        opt.value=p.code; opt.textContent=`${p.code} - ${p.name}`;
        sel.appendChild(opt);
      });
    }
    loadProducts();

    // Şube paneli işlemleri
    const lines=[];
    $("addLineBtn").addEventListener("click", ()=>{
      const code=$("branchProduct").value;
      const name=$("branchProduct").selectedOptions[0].textContent;
      const qty=Number($("branchQty").value);
      lines.push({code,name,qty});
      renderLines();
    });
    function renderLines(){
      const tbody=$("tbl-branch-lines").querySelector("tbody");
      tbody.innerHTML="";
      lines.forEach((l,i)=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${i+1}</td><td>${l.code}</td><td>${l.name}</td><td>${l.qty}</td><td><button class="danger" onclick="lines.splice(${i},1);renderLines()">Sil</button></td>`;
        tbody.appendChild(tr);
      });
    }
    $("createOrderBtn").addEventListener("click", async ()=>{
      const order={name:$("orderName").value, warehouse:$("branchWarehouse").value, lines, status:"Yeni", createdAt:new Date()};
      await addDoc(collection(db,"orders"),order);
      lines.length=0; renderLines(); loadOrders(); alert("Sipariş oluşturuldu!");
    });

    // Yönetici paneli sipariş yükleme
    async function loadOrders(){
      const roleSnap = auth.currentUser ? await getDoc(doc(db,"users",auth.currentUser.uid)) : null;
      const role = roleSnap?.data()?.role;
      if(role==="sube"){
        const tbody=$("branchOrders").querySelector("tbody");
        tbody.innerHTML="";
        const q=await getDocs(collection(db,"orders"));
        q.forEach(d=>{
          const o=d.data();
          const tr=document.createElement("tr");
          tr.innerHTML=`<td>${d.id}</td><td>${o.name}</td><td>${o.warehouse}</td><td>${o.status}</td>`;
          tbody.appendChild(tr);
        });
      }
      if(role==="yonetici"){
        const tbody=$("tbl-orders").querySelector("tbody");
        tbody.innerHTML="";
        const q=await getDocs(collection(db,"orders"));
        let counts={Yeni:0,Atandı:0,Tamamlandı:0};
        q.forEach(d=>{
          const o=d.data();
          const tr=document.createElement("tr");
          tr.innerHTML=`<td>${d.id}</td><td>${o.name}</td><td>${o.warehouse}</td>
          <td><select id="sel-${d.id}">
            ${["Yeni","Atandı","Toplama Başladı","Toplandı","Kontrol","Tamamlandı"]
            .map(s=>`<option ${o.status===s?"selected":""}>${s}</option>`).join("")}
          </select></td>
          <td><button class="success" data-save="${d.id}">Kaydet</button></td>`;
          tbody.appendChild(tr);
          if(counts[o.status]!=null) counts[o.status]++;
        });
        $("statYeni").textContent=counts.Yeni;
        $("statAtandi").textContent=counts.Atandı;
        $("statBitti").textContent=counts.Tamamlandı;
        document.querySelectorAll("button[data-save]").forEach(btn=>{
          btn.addEventListener("click",async()=>{
            const id=btn.dataset.save;
            const val=$("sel-"+id).value;
            await updateDoc(doc(db,"orders",id),{status:val});
            alert("Durum güncellendi."); loadOrders();
          });
        });
      }
    }

    $("refreshOrdersBtn").addEventListener("click",loadOrders);
    $("refreshOrdersAdmin").addEventListener("click",loadOrders);

    $("exportOrdersBtn").addEventListener("click",()=>{
      const data=[["ID","Ad","Şube","Durum"]];
      $("tbl-orders").querySelectorAll("tbody tr").forEach(r=>{
        const c=[...r.cells].slice(0,4).map(td=>td.innerText);
        data.push(c);
      });
      const ws=XLSX.utils.aoa_to_sheet(data);
      const wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb,ws,"Siparişler");
      XLSX.writeFile(wb,`Yonetici_Siparisler_${new Date().toISOString().slice(0,10)}.xlsx`);
    });
  </script>
</body>
</html>
