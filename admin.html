<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>⚙️ TUĞLUBEY — Admin Paneli</title>
  <style>
    body{background:#0f172a;color:#e2e8f0;font-family:system-ui,Arial;margin:0;display:flex;flex-direction:column;align-items:center;min-height:100vh}
    header{background:#111827;width:100%;max-width:1350px;padding:16px 20px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #1e293b;border-radius:0 0 10px 10px}
    h1{margin:0;font-size:22px;color:#93c5fd}
    button{background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:8px 12px;margin:3px;cursor:pointer;font-weight:600}
    button.danger{background:#ef4444}
    button.success{background:#22c55e}
    button.warn{background:#f59e0b;color:#1f2937}
    main{width:100%;max-width:1350px;padding:20px}
    table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}
    th,td{border-bottom:1px solid #1e293b;padding:8px;text-align:left}
    tr:nth-child(even){background:#1e293b33}
    select,input{background:#1e293b;color:#fff;border:1px solid #334155;border-radius:6px;padding:6px 8px}
    #reader{width:320px;height:300px;border:2px dashed #334155;border-radius:10px;margin-top:10px}
    .hidden{display:none}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:20px}
    .tab{padding:8px 16px;border-radius:6px;background:#1e293b;cursor:pointer}
    .tab.active{background:#2563eb}
    canvas{background:#111827;border-radius:8px;padding:10px;margin-top:15px}
    h2{margin-top:25px;color:#bae6fd}
    .card{background:#1e293b;padding:16px;border-radius:8px;margin-top:10px}
    .row{display:flex;flex-wrap:wrap;gap:6px;align-items:center;margin-bottom:8px}
    .input{padding:6px 8px;border-radius:6px;border:1px solid #334155;background:#0f172a;color:#fff}
  </style>
</head>

<body>
  <header>
    <h1>⚙️ TUĞLUBEY — Admin Paneli</h1>
    <div>
      <span id="who"></span>
      <button id="logoutBtn" class="danger">Çıkış</button>
    </div>
  </header>

  <main>
    <div class="tabs">
      <div class="tab active" data-view="orders">📦 Siparişler</div>
      <div class="tab" data-view="users">👥 Kullanıcılar</div>
      <div class="tab" data-view="dashboard">📊 Dashboard</div>
      <div class="tab" data-view="stock">📦 Stok Yönetimi</div>
      <div class="tab" data-view="products">🗂 Ürünler</div>
      <div class="tab" data-view="logs">🧾 Loglar</div>
      <div class="tab" data-view="scanner">📷 Barkod</div>
    </div>

    <!-- 📦 Siparişler -->
    <section id="view-orders">
      <button id="refreshOrdersBtn">Yenile</button>
      <button id="exportOrdersBtn">⬇️ Excel</button>
      <table id="tbl-orders">
        <thead><tr><th>ID</th><th>Adı</th><th>Şube</th><th>Durum</th><th>Kalem</th><th>İşlem</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- 👥 Kullanıcılar -->
    <section id="view-users" class="hidden">
      <button id="refreshUsersBtn">Yenile</button>
      <table id="tbl-users">
        <thead><tr><th>Email</th><th>Rol</th><th>UID</th><th>Yeni Rol</th><th>Kaydet</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- 📊 Dashboard -->
    <section id="view-dashboard" class="hidden">
      <div class="row">
        <div class="card flex-1"><h3>Toplam Sipariş</h3><p id="statTotalOrders">0</p></div>
        <div class="card flex-1"><h3>Tamamlanan Sipariş</h3><p id="statCompletedOrders">0</p></div>
        <div class="card flex-1"><h3>Bekleyen Sipariş</h3><p id="statPendingOrders">0</p></div>
      </div>
      <canvas id="chartStatus" height="160"></canvas>
      <canvas id="chartDaily" height="160"></canvas>
    </section>

    <!-- 📦 Stok Yönetimi -->
    <section id="view-stock" class="hidden">
      <h2>📦 Stok Yönetimi</h2>
      <div class="row">
        <select id="stockWarehouse">
          <option value="MERKEZ">MERKEZ</option><option value="KOCAELİ">KOCAELİ</option><option value="ADAPAZARI">ADAPAZARI</option>
        </select>
        <input id="stockCode" class="input" placeholder="Ürün Kodu"/>
        <input id="stockName" class="input" placeholder="Ürün Adı"/>
        <input id="stockQty" class="input" type="number" placeholder="Miktar"/>
        <button id="btnStockIn" class="success">Giriş</button>
        <button id="btnStockOut" class="danger">Çıkış</button>
      </div>
      <table id="tbl-stock-manage"><thead><tr><th>Kod</th><th>Ad</th><th>Miktar</th><th>Depo</th></tr></thead><tbody></tbody></table>
    </section>

    <!-- 🗂 Ürünler -->
    <section id="view-products" class="hidden">
      <h2>🗂 Ürün Kataloğu</h2>
      <div class="card">
        <h3>Excel’den Ürün Yükle (.xlsx)</h3>
        <div class="row">
          <input type="file" id="excelProducts" accept=".xlsx"/>
          <button id="uploadProductsBtn" class="btn-light">Yükle</button>
        </div>
        <p class="muted">Beklenen sütunlar: <b>code, name</b> (opsiyonel: <i>barcode, reyon</i>)</p>
      </div>
      <table id="tbl-products">
        <thead><tr><th>Kod</th><th>Ad</th><th>Barkod</th><th>Reyon</th></tr></thead><tbody></tbody>
      </table>
    </section>

    <!-- 🧾 Loglar -->
    <section id="view-logs" class="hidden">
      <button id="refreshLogsBtn">Yenile</button>
      <table id="tbl-logs">
        <thead><tr><th>Tarih</th><th>Kullanıcı</th><th>İşlem</th><th>Detay</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- 📷 Barkod -->
    <section id="view-scanner" class="hidden">
      <button id="startScanBtn">Başlat</button>
      <button id="stopScanBtn" class="warn">Durdur</button>
      <div id="reader" class="hidden"></div>
      <p id="scanResult"></p>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.10/minified/html5-qrcode.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/xlsx.mjs" type="module"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
    import * as XLSX from "https://cdn.sheetjs.com/xlsx-0.20.3/package/xlsx.mjs";

    const firebaseConfig = {
      apiKey: "AIzaSyDcLQB4UggXlYA9x8AKw-XybJjcF6U_KA4",
      authDomain: "depo1-4668f.firebaseapp.com",
      projectId: "depo1-4668f",
      storageBucket: "depo1-4668f.appspot.com",
      messagingSenderId: "1044254626353",
      appId: "1:1044254626353:web:148c57df2456cc3d9e3b10"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let scanner=null;

    const $=id=>document.getElementById(id);
    document.querySelectorAll(".tab").forEach(tab=>{
      tab.addEventListener("click",()=>{
        document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
        tab.classList.add("active");
        document.querySelectorAll("main section").forEach(s=>s.classList.add("hidden"));
        $("view-"+tab.dataset.view).classList.remove("hidden");
      });
    });

    onAuthStateChanged(auth,async(user)=>{
      if(!user)return window.location.href="index.html";
      const u=await getDoc(doc(db,"users",user.uid));
      if(!u.exists()||u.data().role!=="admin"){alert("Yetkisiz erişim!");return window.location.href="index.html";}
      $("who").textContent=user.email;
      loadOrders();loadDashboard();loadLogs();
    });

    $("logoutBtn").addEventListener("click",async()=>{await signOut(auth);window.location.href="index.html";});

    // 📦 Siparişler
    async function loadOrders(){
      const tbody=$("tbl-orders").querySelector("tbody");tbody.innerHTML="";
      const q=await getDocs(collection(db,"orders"));
      q.forEach(d=>{
        const o={id:d.id,...d.data()};
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td>${o.id}</td><td>${o.name||""}</td><td>${o.warehouse||"-"}</td><td>${o.status||"?"}</td>
          <td>${o.lines?o.lines.length:0}</td>
          <td>
            <select id="sel-${o.id}">
              ${["Yeni","Atandı","Toplama Başladı","Toplandı","Kontrol","Tamamlandı"].map(s=>`<option ${o.status===s?"selected":""}>${s}</option>`).join("")}
            </select>
            <button data-save="${o.id}" class="success">Kaydet</button>
          </td>`;
        tbody.appendChild(tr);
      });
      document.querySelectorAll("button[data-save]").forEach(btn=>{
        btn.addEventListener("click",async()=>{
          const id=btn.dataset.save;
          const val=$("sel-"+id).value;
          await updateDoc(doc(db,"orders",id),{status:val,lastUpdate:new Date()});
          await addDoc(collection(db,"logs"),{user:$("who").textContent,action:"Sipariş Durumu",detail:`${id} → ${val}`,createdAt:serverTimestamp()});
          alert("Durum güncellendi");loadDashboard();
        });
      });
    }
    $("refreshOrdersBtn").addEventListener("click",loadOrders);

    // ⬇️ Excel
    $("exportOrdersBtn").addEventListener("click",()=>{
      const data=[["ID","Adı","Depo","Durum","Kalem"]];
      $("tbl-orders").querySelectorAll("tbody tr").forEach(r=>{
        const cells=[...r.cells].slice(0,5).map(td=>td.innerText);data.push(cells);
      });
      const ws=XLSX.utils.aoa_to_sheet(data);const wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb,ws,"Siparişler");
      XLSX.writeFile(wb,`TUGLUBEY_Siparisler_${new Date().toISOString().slice(0,10)}.xlsx`);
    });

    // 👥 Kullanıcılar
    async function loadUsers(){
      const tbody=$("tbl-users").querySelector("tbody");tbody.innerHTML="";
      const q=await getDocs(collection(db,"users"));
      q.forEach(d=>{
        const u={id:d.id,...d.data()};
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td>${u.email}</td><td>${u.role}</td><td>${u.id}</td>
          <td><select id="role-${u.id}">
            <option>sube</option><option>toplayici</option><option>yonetici</option>
            <option>qc</option><option>palet</option><option>admin</option>
          </select></td>
          <td><button data-role="${u.id}" class="success">Kaydet</button></td>`;
        tbody.appendChild(tr);
      });
      document.querySelectorAll("button[data-role]").forEach(b=>{
        b.addEventListener("click",async()=>{
          const id=b.dataset.role;const val=$("role-"+id).value;
          await updateDoc(doc(db,"users",id),{role:val});
          await addDoc(collection(db,"logs"),{user:$("who").textContent,action:"Rol Güncelleme",detail:`${id} → ${val}`,createdAt:serverTimestamp()});
          alert("Rol güncellendi");
        });
      });
    }
    $("refreshUsersBtn").addEventListener("click",loadUsers);

    // 📊 Dashboard
    async function loadDashboard(){
      const snap=await getDocs(collection(db,"orders"));
      let counts={},daily={};
      snap.forEach(d=>{
        const o=d.data();counts[o.status]=(counts[o.status]||0)+1;
        const date=o.createdAt?.toDate?o.createdAt.toDate().toISOString().slice(0,10):"Bilinmiyor";
        daily[date]=(daily[date]||0)+1;
      });
      $("statTotalOrders").textContent=snap.size;
      $("statCompletedOrders").textContent=counts["Tamamlandı"]||0;
      $("statPendingOrders").textContent=(counts["Yeni"]||0)+(counts["Atandı"]||0);

      new Chart($("chartStatus").getContext("2d"),{type:"pie",data:{labels:Object.keys(counts),datasets:[{data:Object.values(counts),backgroundColor:["#22c55e","#3b82f6","#facc15","#f97316","#ef4444","#a855f7"]}]}});

      const sorted=Object.keys(daily).sort();
      new Chart($("chartDaily").getContext("2d"),{type:"bar",data:{labels:sorted,datasets:[{label:"Sipariş",data:sorted.map(d=>daily[d]),backgroundColor:"#3b82f6"}]}});
    }

    // 🧾 Loglar
    async function loadLogs(){
      const tbody=$("tbl-logs").querySelector("tbody");tbody.innerHTML="";
      const q=await getDocs(collection(db,"logs"));const logs=[];
      q.forEach(d=>logs.push({id:d.id,...d.data()}));
      logs.sort((a,b)=>b.createdAt?.toDate()-a.createdAt?.toDate());
      logs.slice(0,50).forEach(l=>{
        const t=l.createdAt?.toDate?l.createdAt.toDate().toLocaleString():"-";
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${t}</td><td>${l.user}</td><td>${l.action}</td><td>${l.detail}</td>`;
        tbody.appendChild(tr);
      });
    }
    $("refreshLogsBtn").addEventListener("click",loadLogs);

    // 📷 Barkod
    $("startScanBtn").addEventListener("click",async()=>{
      if(scanner)return;$("reader").classList.remove("hidden");
      scanner=new Html5Qrcode("reader");
      await scanner.start({facingMode:"environment"},{fps:10,qrbox:250
