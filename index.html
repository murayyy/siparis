<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sesli Envanter Takip UygulamasÄ±</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }

        /* Okunuyor butonu animasyonu */
        .speaking {
            animation: pulse-ring 1s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
        }
        @keyframes pulse-ring {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-blue-800">Depo Envanter Paneli</h1>
            <p class="text-gray-600 mt-2">Stok durumunuzu gÃ¶rÃ¼ntÃ¼leyin ve aÃ§Ä±klamalarÄ± dinleyin.</p>
        </header>

        <!-- Yeni ÃœrÃ¼n Ekleme Formu -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Yeni ÃœrÃ¼n Ekle</h2>
            <form id="add-item-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input
                    type="text"
                    id="name"
                    placeholder="ÃœrÃ¼n AdÄ± (Ã–rn: Mavi GÃ¶mlek)"
                    required
                    class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 col-span-1 md:col-span-1"
                />
                <input
                    type="number"
                    id="quantity"
                    placeholder="Stok Adedi (Ã–rn: 50)"
                    required
                    min="1"
                    class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                />
                <textarea
                    id="description"
                    placeholder="AÃ§Ä±klama (Ã–rn: %100 pamuk, yazlÄ±k model)"
                    rows="1"
                    required
                    class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 md:col-span-2"
                ></textarea>
                <button
                    type="submit"
                    class="col-span-1 md:col-span-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-md"
                >
                    Envantere Ekle
                </button>
            </form>
        </div>

        <!-- Envanter Listesi -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">
                Mevcut Envanter (<span id="item-count">0</span> ÃœrÃ¼n)
            </h2>
            <div id="inventory-list" class="space-y-4">
                <!-- Envanter Ã¶ÄŸeleri buraya eklenecek -->
            </div>
            <p id="empty-message" class="text-center text-gray-500 p-8">
                Envanteriniz boÅŸ. LÃ¼tfen yukarÄ±daki formu kullanarak Ã¼rÃ¼n ekleyin.
            </p>
        </div>

        <!-- Genel Hata/Mesaj Kutusu -->
        <div
            id="message-box"
            class="fixed bottom-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl shadow-xl hidden"
            role="alert"
        >
            <span id="message-text" class="block sm:inline"></span>
            <span
                class="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer"
                onclick="document.getElementById('message-box').classList.add('hidden')"
            >
                <svg
                    class="fill-current h-6 w-6 text-red-500"
                    role="button"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 20 20"
                >
                    <title>Kapat</title>
                    <path
                        d="M14.348 14.849a1.002 1.002 0 01-1.414 0L10 11.414l-2.934 2.935a1.002 1.002 0 11-1.414-1.414l2.934-2.935-2.934-2.935a1.002 1.002 0 011.414-1.414l2.934 2.935 2.934-2.935a1.002 1.002 0 011.414 1.414l-2.934 2.935 2.934 2.935a1.002 1.002 0 010 1.414z"
                    />
                </svg>
            </span>
        </div>
    </div>

    <script type="module">
        // --------------------------------------------------------------------
        // 0) Ortam (Canvas / Host) DeÄŸiÅŸkenleri
        // --------------------------------------------------------------------
        const appId =
            typeof window.__app_id !== "undefined" ? window.__app_id : "default-app-id";
        const firebaseConfig =
            typeof window.__firebase_config !== "undefined"
                ? JSON.parse(window.__firebase_config)
                : null;

        // --------------------------------------------------------------------
        // 1) Firebase & Firestore Import
        // --------------------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            collection,
            onSnapshot,
            addDoc,
            deleteDoc,
            doc,
            setLogLevel,
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --------------------------------------------------------------------
        // 2) Uygulama Durum DeÄŸiÅŸkenleri
        // --------------------------------------------------------------------
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        const INVENTORY_COLLECTION = "inventory_items";

        // DOM referanslarÄ±
        const form = document.getElementById("add-item-form");
        const inventoryList = document.getElementById("inventory-list");
        const emptyMessage = document.getElementById("empty-message");
        const itemCount = document.getElementById("item-count");

        // --------------------------------------------------------------------
        // 3) Mesaj Kutusu YardÄ±mcÄ± Fonksiyonu
        // --------------------------------------------------------------------
        function showMessage(text, isError = false) {
            const box = document.getElementById("message-box");
            const messageText = document.getElementById("message-text");

            messageText.textContent = text;
            box.classList.remove(
                "hidden",
                "bg-red-100",
                "bg-green-100",
                "border-red-400",
                "border-green-400",
                "text-red-700",
                "text-green-700"
            );

            if (isError) {
                box.classList.add("bg-red-100", "border-red-400", "text-red-700");
            } else {
                box.classList.add("bg-green-100", "border-green-400", "text-green-700");
            }

            setTimeout(() => box.classList.add("hidden"), 5000);
        }

        // --------------------------------------------------------------------
        // 4) Firebase BaÅŸlatma ve Kimlik DoÄŸrulama
        // --------------------------------------------------------------------
        async function initializeFirebase() {
            if (!firebaseConfig) {
                showMessage(
                    "Hata: Firebase yapÄ±landÄ±rmasÄ± eksik. Uygulama baÅŸlatÄ±lamadÄ±.",
                    true
                );
                return;
            }

            try {
                // Firestore log seviyesi
                setLogLevel("debug");

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Auth denemesi
                try {
                    const token = window.__initial_auth_token;
                    const userIdElement = document.getElementById("current-user-id");
                    if (userIdElement) {
                        userIdElement.textContent = "Oturum AÃ§Ä±lÄ±yor...";
                    }

                    if (typeof token === "string" && token.length > 0) {
                        await signInWithCustomToken(auth, token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (authError) {
                    console.error("Oturum AÃ§ma HatasÄ±:", authError);
                    showMessage(
                        "Oturum aÃ§Ä±lÄ±rken bir hata oluÅŸtu. Envanter yÃ¼klenemeyebilir.",
                        true
                    );
                }

                // Auth durumu dinleme
                onAuthStateChanged(auth, (user) => {
                    const userIdElement = document.getElementById("current-user-id");

                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;

                        if (userIdElement) {
                            userIdElement.textContent = user.uid;
                        }

                        listenToInventory();
                        showMessage(`Oturum aÃ§Ä±ldÄ±. KullanÄ±cÄ± ID: ${userId}`, false);
                    } else {
                        userId = null;
                        isAuthReady = false;
                        if (userIdElement) {
                            userIdElement.textContent =
                                "Anonim GiriÅŸ YapÄ±lamadÄ±/Bekleniyor...";
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase BaÅŸlatma HatasÄ±:", error);
                showMessage(
                    "Uygulama baÅŸlatÄ±lÄ±rken kritik bir hata oluÅŸtu.",
                    true
                );
            }
        }

        // KullanÄ±cÄ±ya Ã¶zel koleksiyon referansÄ±
        function getUserInventoryRef() {
            if (!db || !userId) return null;
            const basePath = `artifacts/${appId}/users/${userId}`;
            return collection(db, `${basePath}/${INVENTORY_COLLECTION}`);
        }

        // --------------------------------------------------------------------
        // 5) Envanteri Dinleme (Real-time Snapshot)
        // --------------------------------------------------------------------
        function listenToInventory() {
            if (!isAuthReady || !userId) return;

            const userInventoryRef = getUserInventoryRef();
            if (!userInventoryRef) return;

            onSnapshot(
                userInventoryRef,
                (snapshot) => {
                    const items = [];
                    snapshot.forEach((d) => items.push({ id: d.id, ...d.data() }));

                    // Stoka gÃ¶re sÄ±rala (bÃ¼yÃ¼kten kÃ¼Ã§Ã¼ÄŸe)
                    items.sort((a, b) => (b.quantity || 0) - (a.quantity || 0));

                    renderInventory(items);
                },
                (error) => {
                    console.error("Envanter Dinleme HatasÄ±:", error);
                    showMessage(
                        "Envanter yÃ¼klenirken bir sorun oluÅŸtu.",
                        true
                    );
                }
            );
        }

        // --------------------------------------------------------------------
        // 6) Envanteri DOM'a Render Etme
        // --------------------------------------------------------------------
        function renderInventory(items) {
            inventoryList.innerHTML = "";
            itemCount.textContent = items.length;

            if (items.length === 0) {
                emptyMessage.classList.remove("hidden");
                return;
            }

            emptyMessage.classList.add("hidden");

            items.forEach((item) => {
                let stockClass = "";
                if (item.quantity <= 10) {
                    stockClass = "text-red-600 font-bold"; // Kritik
                } else if (item.quantity <= 50) {
                    stockClass = "text-yellow-600"; // Orta
                } else {
                    stockClass = "text-blue-600"; // Ä°yi
                }

                const wrapper = document.createElement("div");
                wrapper.className =
                    "bg-gray-50 p-4 rounded-xl shadow-md flex flex-col sm:flex-row justify-between items-start sm:items-center transition duration-150 hover:bg-gray-100";

                wrapper.innerHTML = `
                    <div class="flex-grow mb-3 sm:mb-0">
                        <p class="text-lg font-bold text-gray-900">
                            ${item.name}
                            <span class="text-sm font-normal text-gray-500">
                                (${item.id?.substring(0, 5) || "---"}...)
                            </span>
                        </p>
                        <p class="text-sm text-gray-600 truncate max-w-xs">
                            ${item.description}
                        </p>
                        <p class="text-xs ${stockClass} mt-1">
                            Stok: ${item.quantity}
                        </p>
                    </div>
                    <div class="flex space-x-2">
                        <button
                            data-id="${item.id}"
                            data-text="${item.description}"
                            class="speak-btn bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center transition duration-200 text-sm"
                        >
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9c2.5 2.5 2.5 6.566 0 9.066M9 5v14m-4-4h3m9-4h3" />
                            </svg>
                            AÃ§Ä±klamayÄ± Dinle
                        </button>
                        <button
                            data-id="${item.id}"
                            class="delete-btn bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg text-sm transition duration-200"
                        >
                            Sil
                        </button>
                    </div>
                `;

                inventoryList.appendChild(wrapper);
            });
        }

        // --------------------------------------------------------------------
        // 7) Yeni ÃœrÃ¼n Ekleme
        // --------------------------------------------------------------------
        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            if (!isAuthReady || !userId) {
                showMessage(
                    "LÃ¼tfen kimlik doÄŸrulamanÄ±n tamamlanmasÄ±nÄ± bekleyin.",
                    true
                );
                return;
            }

            const name = document.getElementById("name").value.trim();
            const quantity = parseInt(
                document.getElementById("quantity").value,
                10
            );
            const description = document
                .getElementById("description")
                .value.trim();

            if (!name || isNaN(quantity) || quantity <= 0 || !description) {
                showMessage(
                    "LÃ¼tfen tÃ¼m alanlarÄ± geÃ§erli ÅŸekilde doldurun.",
                    true
                );
                return;
            }

            const newItem = {
                name,
                quantity,
                description,
                createdAt: Date.now(),
            };

            try {
                const userInventoryRef = getUserInventoryRef();
                if (!userInventoryRef) {
                    showMessage(
                        "VeritabanÄ± baÄŸlantÄ±sÄ± kurulamadÄ±.",
                        true
                    );
                    return;
                }

                await addDoc(userInventoryRef, newItem);
                showMessage(
                    `${name} envantere baÅŸarÄ±yla eklendi!`,
                    false
                );
                form.reset();
            } catch (error) {
                console.error("ÃœrÃ¼n Ekleme HatasÄ±:", error);
                showMessage(
                    "ÃœrÃ¼n eklenirken bir hata oluÅŸtu.",
                    true
                );
            }
        });

        // --------------------------------------------------------------------
        // 8) ÃœrÃ¼n Silme
        // --------------------------------------------------------------------
        inventoryList.addEventListener("click", async (e) => {
            const deleteBtn = e.target.closest(".delete-btn");
            if (!deleteBtn) return;

            const itemId = deleteBtn.dataset.id;
            if (!itemId || !db || !userId) return;

            // Emin misin pop-up'Ä±nÄ± istersen buraya ekleyebilirsin:
            // if (!confirm("Bu Ã¼rÃ¼nÃ¼ silmek istediÄŸinize emin misiniz?")) return;

            const basePath = `artifacts/${appId}/users/${userId}`;
            const docRef = doc(
                db,
                `${basePath}/${INVENTORY_COLLECTION}`,
                itemId
            );

            try {
                await deleteDoc(docRef);
                showMessage("ÃœrÃ¼n baÅŸarÄ±yla silindi.", false);
            } catch (error) {
                console.error("ÃœrÃ¼n Silme HatasÄ±:", error);
                showMessage(
                    "ÃœrÃ¼n silinirken bir hata oluÅŸtu.",
                    true
                );
            }
        });

        // --------------------------------------------------------------------
        // 9) Sesli Okuma (TarayÄ±cÄ± SpeechSynthesis API)
        // --------------------------------------------------------------------
        const synth = window.speechSynthesis;
        let currentButton = null;

        function speakText(text, button) {
            if (!synth) {
                showMessage(
                    "Hata: TarayÄ±cÄ±nÄ±z sesli okuma (Text-to-Speech) Ã¶zelliÄŸini desteklemiyor.",
                    true
                );
                return;
            }

            // EÄŸer aynÄ± butona tÄ±klayÄ±p konuÅŸma devam ediyorsa â†’ durdur
            if (currentButton && button === currentButton && synth.speaking) {
                try {
                    synth.cancel();
                } catch (e) {}
                return;
            }

            // Ã–nce varsa eski konuÅŸmayÄ± iptal et
            if (synth.speaking) {
                try {
                    synth.cancel();
                } catch (e) {}
            }

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = "tr-TR";

            // Orijinal HTML'yi sadece ilk seferde kaydet
            if (!button.dataset.originalHtml) {
                button.dataset.originalHtml = button.innerHTML;
            }

            utterance.onstart = () => {
                currentButton = button;
                button.classList.add("speaking");
                button.innerHTML = "ðŸ”Š Durduruluyor...";
            };

            const resetButton = () => {
                if (currentButton) {
                    currentButton.classList.remove("speaking");
                    if (currentButton.dataset.originalHtml) {
                        currentButton.innerHTML =
                            currentButton.dataset.originalHtml;
                    } else {
                        currentButton.innerHTML = "AÃ§Ä±klamayÄ± Dinle";
                    }
                }
                currentButton = null;
            };

            utterance.onend = resetButton;
            utterance.onerror = resetButton;

            synth.speak(utterance);
        }

        // Sesli okuma butonuna tÄ±klama
        inventoryList.addEventListener("click", (e) => {
            const btn = e.target.closest(".speak-btn");
            if (!btn) return;
            const text = btn.dataset.text || "";
            if (!text) {
                showMessage(
                    "Bu Ã¼rÃ¼n iÃ§in aÃ§Ä±klama bulunamadÄ±.",
                    true
                );
                return;
            }
            speakText(text, btn);
        });

        // --------------------------------------------------------------------
        // 10) Uygulama BaÅŸlatma + KullanÄ±cÄ± ID GÃ¶sterimi
        // --------------------------------------------------------------------
        window.onload = initializeFirebase;

        const userIdDisplay = document.createElement("p");
        userIdDisplay.className =
            "text-center text-sm text-gray-400 mt-6";
        userIdDisplay.innerHTML =
            'Mevcut KullanÄ±cÄ± ID: <span id="current-user-id" class="font-mono text-xs">Bekleniyor...</span>';
        document.getElementById("app").appendChild(userIdDisplay);
    </script>
</body>
</html>
