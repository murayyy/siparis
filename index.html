<!DOCTYPE html>
<html lang="tr" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>ğŸ“¦ Depo Otomasyonu â€¢ Kurumsal Web UygulamasÄ±</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='16' fill='%2300796b'/><text x='50' y='60' font-size='54' text-anchor='middle' fill='white'>ğŸ“¦</text></svg>"/>

  <!-- Manifest & SW (opsiyonel; PWA iÃ§in) -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#00796b" />

  <!-- Firebase + App -->
  <script type="module" src="firebase.js"></script>
  <script type="module" src="app.js" defer></script>

  <style>
    /* Ek minimal stiller (style.css ile birlikte Ã§alÄ±ÅŸÄ±r) */
    :root { --sidebar-w: 260px; }
    body, html { height: 100%; }
    .layout { display: grid; grid-template-columns: var(--sidebar-w) 1fr; grid-template-rows: 56px 1fr; grid-template-areas: 'topbar topbar' 'sidebar main'; min-height: 100vh; }
    .topbar { grid-area: topbar; background: var(--primary); color: #fff; display:flex; align-items:center; padding: 0 12px; gap: 8px; }
    .topbar .brand { font-weight: 700; letter-spacing: .3px; display:flex; align-items:center; gap: 8px; }
    .topbar .brand .logo { width: 28px; height: 28px; display:inline-grid; place-items:center; background: rgba(255,255,255,.15); border-radius: 6px; }
    .topbar .spacer { flex:1; }
    .sidebar { grid-area: sidebar; background: #fff; border-right:1px solid #e5e7eb; overflow:auto; }
    .sidebar .section-title { padding: 14px 16px; font-size: 12px; color:#6b7280; text-transform:uppercase; letter-spacing: .08em; }
    .sidebar a { display:flex; align-items:center; gap: 10px; padding: 10px 14px; text-decoration:none; color: inherit; border-left:3px solid transparent; }
    .sidebar a:hover { background:#f3f4f6; }
    .sidebar a.active { background:#eefcf9; border-left-color: var(--primary); color: var(--primary); font-weight:600; }
    .main { grid-area: main; padding: 16px; }

    .grid { display:grid; gap:12px; }
    .g-2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
    .g-3 { grid-template-columns: repeat(3, minmax(0,1fr)); }
    .g-4 { grid-template-columns: repeat(4, minmax(0,1fr)); }
    @media (max-width: 1100px) { .g-4{grid-template-columns: repeat(2, minmax(0,1fr));} }
    @media (max-width: 800px) { .layout{grid-template-columns: 1fr; grid-template-areas: 'topbar' 'main';} .sidebar{display:none;} }

    .kpi { display:flex; flex-direction:column; gap:6px; }
    .kpi .num { font-size: 26px; font-weight: 700; }

    .toolbar { display:flex; flex-wrap:wrap; gap: 8px; align-items:center; margin-bottom: 12px; }
    .toolbar .spacer { flex:1; }

    .table { width:100%; border-collapse: collapse; background:#fff; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .table th, .table td { border-bottom:1px solid #eee; padding: 10px; text-align:left; font-size: 14px; }
    .table th { background: #f9fafb; font-size: 12px; color:#6b7280; text-transform: uppercase; letter-spacing: .06em; }
    .badge { padding: 2px 6px; border-radius: 999px; font-size: 12px; background:#eef2ff; color:#3730a3; }
    .badge.green { background:#ecfdf5; color:#065f46; }
    .badge.yellow { background:#fffbeb; color:#92400e; }
    .badge.gray { background:#f3f4f6; color:#374151; }

    .split { display:grid; grid-template-columns: 1.2fr .8fr; gap:12px; }
    @media (max-width: 1100px) { .split { grid-template-columns: 1fr; } }

    .muted { color:#6b7280; font-size: 12px; }
    .danger { color: var(--danger); }

    dialog.modal { border:none; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,.25); width:min(900px, 92vw); max-height:90vh; }
    dialog::backdrop { background: rgba(0,0,0,.45); }

    .pill { border-radius: 999px; padding: 4px 10px; background:#f3f4f6; }
    .nowrap { white-space: nowrap; }
  </style>
</head>

<body>
  <!-- LAYOUT -->
  <div class="layout">
    <!-- TOPBAR -->
    <div class="topbar">
      <div class="brand">
        <span class="logo">ğŸ“¦</span>
        <span>Depo Otomasyonu</span>
      </div>
      <div class="pill" id="envBadge">WEB â€¢ PROD</div>
      <div class="spacer"></div>
      <button id="btnLogin" class="btn">GiriÅŸ</button>
      <button id="btnLogout" class="btn hidden">Ã‡Ä±kÄ±ÅŸ</button>
    </div>

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="section-title">MenÃ¼</div>
      <a href="#dashboard" data-view="dashboard" class="active" id="navDashboard">ğŸ  Dashboard</a>
      <a href="#orders" data-view="orders" id="navOrders">ğŸ§¾ SipariÅŸler</a>
      <a href="#picking" data-view="picking" id="navPicking">ğŸ§º Toplama</a>
      <a href="#qc" data-view="qc" id="navQC">âœ… QC / Kontrol</a>
      <a href="#ekdepo" data-view="ekdepo" id="navEkDepo">â• Ek Depo</a>
      <a href="#archive" data-view="archive" id="navArchive">ğŸ—ƒï¸ ArÅŸiv</a>

      <div class="section-title">Stok & Etiket</div>
      <a href="#inventory" data-view="inventory" id="navInventory">ğŸ“¦ Envanter</a>
      <a href="#labels" data-view="labels" id="navLabels">ğŸ·ï¸ Etiket & Barkod</a>

      <div class="section-title">Raporlama</div>
      <a href="#reports" data-view="reports" id="navReports">ğŸ“Š Raporlar</a>

      <div class="section-title">Sistem</div>
      <a href="#settings" data-view="settings" id="navSettings">âš™ï¸ Ayarlar</a>
      <a href="#help" data-view="help" id="navHelp">â“ YardÄ±m</a>
    </aside>

    <!-- MAIN -->
    <main class="main" id="appMain">

      <!-- VIEW: LOGIN (overlay) -->
      <section id="loginSection">
        <div class="grid g-2">
          <div class="card">
            <h2>GiriÅŸ</h2>
            <p class="muted">Eâ€‘posta ve ÅŸifreniz ile giriÅŸ yapÄ±n.</p>
            <input id="email" type="email" placeholder="Eâ€‘posta" />
            <input id="password" type="password" placeholder="Åifre" />
            <div class="toolbar">
              <button id="signinBtn" class="btn btn-primary">GiriÅŸ Yap</button>
              <span id="loginMsg" class="muted"></span>
            </div>
          </div>

          <div class="card">
            <h3>HÄ±zlÄ± Bilgi</h3>
            <ul>
              <li>RBAC: Manager / Picker / QC</li>
              <li>F9: CSV dÄ±ÅŸa aktar</li>
              <li>F1: Ayarlar</li>
              <li>Ctrl+Z / Ctrl+Y: Geri al / Yinele</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- VIEW: DASHBOARD -->
      <section id="view-dashboard">
        <div class="toolbar">
          <h2>Dashboard</h2>
          <div class="spacer"></div>
          <button class="btn" id="btnRefreshDashboard">Yenile</button>
        </div>
        <div class="grid g-4">
          <div class="card kpi"><div class="muted">Toplam SipariÅŸ</div><div class="num" id="kpiOrders">0</div></div>
          <div class="card kpi"><div class="muted">Toplam Kalem</div><div class="num" id="kpiLines">0</div></div>
          <div class="card kpi"><div class="muted">Bekleyen QC</div><div class="num" id="kpiQC">0</div></div>
          <div class="card kpi"><div class="muted">Tamamlanan</div><div class="num" id="kpiDone">0</div></div>
        </div>

        <div class="split" style="margin-top:12px;">
          <div class="card">
            <div class="toolbar">
              <strong>Son SipariÅŸler</strong>
              <div class="spacer"></div>
              <button class="btn" id="btnDashCSV">CSV</button>
            </div>
            <table class="table" id="tblDashOrders">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Åube</th>
                  <th>Durum</th>
                  <th>OluÅŸturma</th>
                  <th class="nowrap">Atanan</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="card">
            <div class="toolbar"><strong>Durumlara GÃ¶re</strong></div>
            <div id="statusChart" style="height:280px; display:grid; place-items:center;" class="muted">(Basit Ã§ubuk grafik â€” app.js hesaplÄ±yor)</div>
          </div>
        </div>
      </section>

      <!-- VIEW: ORDERS -->
      <section id="view-orders" class="hidden">
        <div class="toolbar">
          <h2>SipariÅŸler</h2>
          <div class="spacer"></div>
          <input id="qOrders" placeholder="Ara: ÅŸube, Ã¼rÃ¼n, kod..." style="max-width:280px" />
          <button class="btn" id="btnOrdersCSV">CSV DÄ±ÅŸa Aktar</button>
          <label class="btn">
            <input type="file" id="inpOrdersCSV" accept=".csv" style="display:none" />
            CSV Ä°Ã§e Aktar
          </label>
          <button class="btn btn-secondary" id="btnNewOrder">Yeni SipariÅŸ</button>
        </div>

        <div id="orderList" class="grid"></div>
      </section>

      <!-- VIEW: PICKING -->
      <section id="view-picking" class="hidden">
        <div class="toolbar">
          <h2>Toplama</h2>
          <div class="spacer"></div>
          <button class="btn" id="btnPickingRefresh">Yenile</button>
        </div>
        <div id="pickingList" class="grid"></div>
      </section>

      <!-- VIEW: QC -->
      <section id="view-qc" class="hidden">
        <div class="toolbar">
          <h2>QC / Kontrol</h2>
          <div class="spacer"></div>
          <button class="btn" id="btnQCRefresh">Yenile</button>
        </div>
        <div id="qcList" class="grid"></div>
      </section>

      <!-- VIEW: EK DEPO -->
      <section id="view-ekdepo" class="hidden">
        <div class="toolbar">
          <h2>Ek Depo (Eksikler)</h2>
          <div class="spacer"></div>
          <button class="btn" id="btnEkDepoRefresh">Yenile</button>
        </div>
        <table class="table" id="tblEkDepo">
          <thead>
            <tr>
              <th>ÃœrÃ¼n</th>
              <th>Kod</th>
              <th>Raf</th>
              <th>Miktar</th>
              <th>Not</th>
              <th>Aksiyon</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- VIEW: ARCHIVE -->
      <section id="view-archive" class="hidden">
        <div class="toolbar">
          <h2>ArÅŸiv</h2>
          <div class="spacer"></div>
          <button class="btn" id="btnArchiveRefresh">Yenile</button>
        </div>
        <div id="archiveList" class="grid"></div>
      </section>

      <!-- VIEW: INVENTORY -->
      <section id="view-inventory" class="hidden">
        <div class="toolbar">
          <h2>Envanter</h2>
          <div class="spacer"></div>
          <button class="btn" id="btnInventoryScan">Barkod Tara</button>
          <button class="btn" id="btnInventoryRefresh">Yenile</button>
        </div>
        <div class="split">
          <div class="card">
            <strong>ÃœrÃ¼n Listesi</strong>
            <table class="table" id="tblInventory">
              <thead>
                <tr>
                  <th>ÃœrÃ¼n</th>
                  <th>Kod</th>
                  <th>Raf</th>
                  <th>Stok</th>
                  <th>Son Hareket</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="card">
            <strong>HÄ±zlÄ± Ä°ÅŸlemler</strong>
            <div class="grid g-2" style="margin-top: 8px;">
              <div class="card">
                <div class="muted">Stok GiriÅŸ</div>
                <input id="invInCode" placeholder="Kod" />
                <input id="invInQty" type="number" placeholder="Miktar" />
                <button class="btn btn-primary" id="btnInvIn">Kaydet</button>
              </div>
              <div class="card">
                <div class="muted">Stok Ã‡Ä±kÄ±ÅŸ</div>
                <input id="invOutCode" placeholder="Kod" />
                <input id="invOutQty" type="number" placeholder="Miktar" />
                <button class="btn btn-danger" id="btnInvOut">Kaydet</button>
              </div>
            </div>
            <div class="muted" style="margin-top:8px">Not: Bu modÃ¼l demo amaÃ§lÄ±dÄ±r; gerÃ§ek stoklar Firestore/Mikro ile senkronize edilir.</div>
          </div>
        </div>
      </section>

      <!-- VIEW: LABELS -->
      <section id="view-labels" class="hidden">
        <div class="toolbar">
          <h2>Etiket & Barkod</h2>
          <div class="spacer"></div>
          <button class="btn" id="btnLabelPreview">Ã–n Ä°zleme</button>
          <button class="btn" id="btnLabelPrint">YazdÄ±r</button>
        </div>
        <div class="grid g-3">
          <div class="card">
            <strong>100Ã—100 mm Argox</strong>
            <p class="muted">Kodu, isim, fiyat, lot, tarih</p>
            <svg viewBox="0 0 300 150" style="width:100%;background:#fff;border:1px solid #eee;border-radius:6px">
              <rect x="8" y="8" width="284" height="134" rx="8" fill="#f8fafc" stroke="#e2e8f0"/>
              <text x="20" y="32" font-size="16">ÃœRÃœN ADI</text>
              <text x="20" y="56" font-size="12" fill="#4b5563">KOD: PRDâ€‘0001</text>
              <text x="20" y="76" font-size="12" fill="#4b5563">LOT: 2409â€‘001</text>
              <text x="20" y="96" font-size="12" fill="#4b5563">TARÄ°H: 11.11.2025</text>
              <rect x="180" y="36" width="100" height="100" fill="#111" rx="6" />
            </svg>
          </div>
          <div class="card">
            <strong>Raf Etiketi 58Ã—40</strong>
            <p class="muted">ÃœrÃ¼n adÄ± + Barkod</p>
            <svg viewBox="0 0 300 150" style="width:100%;background:#fff;border:1px solid #eee;border-radius:6px">
              <rect x="8" y="8" width="284" height="134" rx="8" fill="#fff" stroke="#e2e8f0"/>
              <text x="20" y="40" font-size="18">KAVRULMUÅ BADEM 500g</text>
              <rect x="20" y="60" width="260" height="60" fill="#111"/>
            </svg>
          </div>
          <div class="card">
            <strong>Palet Etiketi A5</strong>
            <p class="muted">SipariÅŸ ID + Åube + Tarih</p>
            <svg viewBox="0 0 300 150" style="width:100%;background:#fff;border:1px solid #eee;border-radius:6px">
              <rect x="8" y="8" width="284" height="134" rx="8" fill="#fff" stroke="#e2e8f0"/>
              <text x="20" y="40" font-size="20">SIPâ€‘10045</text>
              <text x="20" y="70" font-size="14">Åube: KonyaaltÄ±</text>
              <text x="20" y="92" font-size="14">Tarih: 11.11.2025</text>
            </svg>
          </div>
        </div>
      </section>

      <!-- VIEW: REPORTS -->
      <section id="view-reports" class="hidden">
        <div class="toolbar">
          <h2>Raporlar</h2>
          <div class="spacer"></div>
          <button class="btn" id="btnReportGenerate">Raporu OluÅŸtur</button>
          <button class="btn" id="btnReportExport">PDF</button>
        </div>
        <div class="card">
          <div class="grid g-3">
            <div>
              <label class="muted">Tarih (BaÅŸlangÄ±Ã§)</label>
              <input id="repStart" type="date" />
            </div>
            <div>
              <label class="muted">Tarih (BitiÅŸ)</label>
              <input id="repEnd" type="date" />
            </div>
            <div>
              <label class="muted">Durum</label>
              <select id="repStatus">
                <option value="">TÃ¼mÃ¼</option>
                <option>created</option>
                <option>assigned</option>
                <option>picking</option>
                <option>picked</option>
                <option>qc</option>
                <option>completed</option>
                <option>archived</option>
              </select>
            </div>
          </div>
        </div>
        <table class="table" id="tblReport">
          <thead>
            <tr>
              <th>ID</th>
              <th>Åube</th>
              <th>Durum</th>
              <th>Kalem</th>
              <th>OluÅŸturma</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- VIEW: SETTINGS -->
      <section id="view-settings" class="hidden">
        <div class="toolbar">
          <h2>Ayarlar</h2>
          <div class="spacer"></div>
          <button class="btn" id="btnClearCache">Cache Temizle</button>
        </div>
        <div class="grid g-3">
          <div class="card">
            <strong>Tema</strong>
            <select id="selTheme">
              <option value="light">Light</option>
              <option value="dark">Dark</option>
            </select>
          </div>
          <div class="card">
            <strong>Dil</strong>
            <select id="selLang">
              <option value="tr">TÃ¼rkÃ§e</option>
              <option value="en">English</option>
            </select>
          </div>
          <div class="card">
            <strong>Bildirimler</strong>
            <button class="btn" id="btnNotify">Ä°zin Ä°ste</button>
          </div>
        </div>
      </section>

      <!-- VIEW: HELP -->
      <section id="view-help" class="hidden">
        <div class="toolbar"><h2>YardÄ±m</h2></div>
        <div class="card">
          <h3>KÄ±sayollar</h3>
          <ul>
            <li>F1: Ayarlar</li>
            <li>F9: CSV dÄ±ÅŸa aktarma</li>
            <li>Ctrl+Z / Ctrl+Y: Geri al / Yinele</li>
          </ul>
        </div>
        <div class="card">
          <h3>Hata Ã‡Ã¶zÃ¼mÃ¼</h3>
          <p class="muted">BaÄŸlantÄ± sorunlarÄ±nda tarayÄ±cÄ± konsolunu ve Firestore kurallarÄ±nÄ± kontrol edin.</p>
        </div>
      </section>

      <!-- DIALOGS / MODALS TEMPLATES -->
      <dialog id="dlgOrder" class="modal">
        <form method="dialog">
          <div class="toolbar">
            <h3>SipariÅŸ</h3>
            <div class="spacer"></div>
            <button class="btn" value="close">Kapat</button>
          </div>
          <div class="grid g-3">
            <div>
              <label class="muted">Åube</label>
              <input id="dlgBranch" placeholder="Åube adÄ±"/>
            </div>
            <div>
              <label class="muted">ÃœrÃ¼n</label>
              <input id="dlgProduct" placeholder="ÃœrÃ¼n adÄ±"/>
            </div>
            <div>
              <label class="muted">Miktar</label>
              <input id="dlgQty" type="number" placeholder="Miktar"/>
            </div>
          </div>
          <div class="toolbar">
            <button class="btn btn-primary" id="dlgSave">Kaydet</button>
          </div>
        </form>
      </dialog>

      <dialog id="dlgDetail" class="modal">
        <form method="dialog">
          <div class="toolbar">
            <h3 id="dlgDetailTitle">SipariÅŸ DetayÄ±</h3>
            <div class="spacer"></div>
            <button class="btn" value="close">Kapat</button>
          </div>
          <div id="dlgDetailBody" class="grid"></div>
          <div class="toolbar">
            <button class="btn" id="btnDetailStart">Toplamaya BaÅŸla</button>
            <button class="btn btn-primary" id="btnDetailSendQC">QC'ye GÃ¶nder</button>
            <button class="btn" id="btnDetailArchive">ArÅŸivle</button>
            <button class="btn btn-primary" id="btnDetailQCApprove">QC Onayla</button>
          </div>
        </form>
      </dialog>

      <dialog id="dlgScanner" class="modal">
        <form method="dialog">
          <div class="toolbar">
            <h3>Barkod/QR Tara</h3>
            <div class="spacer"></div>
            <button class="btn" value="close">Kapat</button>
          </div>
          <video id="cam" autoplay playsinline style="width:100%;border-radius:8px;background:#000;min-height:260px"></video>
          <div class="toolbar">
            <span class="muted">Kodu okuttuktan sonra pencereyi kapatabilirsiniz.</span>
          </div>
        </form>
      </dialog>

    </main>
  </div>

  <footer style="text-align:center; padding:16px; font-size:12px; color:#6b7280">Â© 2025 Depo Otomasyonu â€” TuÄŸlular Group</footer>

  <script>
    // Basit router: sidebar linkleri ile view deÄŸiÅŸimi
    const views = {
      dashboard: document.getElementById('view-dashboard'),
      orders: document.getElementById('view-orders'),
      picking: document.getElementById('view-picking'),
      qc: document.getElementById('view-qc'),
      ekdepo: document.getElementById('view-ekdepo'),
      archive: document.getElementById('view-archive'),
      inventory: document.getElementById('view-inventory'),
      labels: document.getElementById('view-labels'),
      reports: document.getElementById('view-reports'),
      settings: document.getElementById('view-settings'),
      help: document.getElementById('view-help')
    };

    function activate(id){
      for(const k in views){ views[k].classList.add('hidden'); }
      if(views[id]) views[id].classList.remove('hidden');
      document.querySelectorAll('.sidebar a').forEach(a=> a.classList.remove('active'));
      const active = document.querySelector(`.sidebar a[data-view="${id}"]`);
      if(active) active.classList.add('active');
    }

    document.querySelectorAll('.sidebar a').forEach(a=>{
      a.addEventListener('click', (e)=>{
        e.preventDefault(); activate(a.dataset.view);
        history.replaceState(null, '', a.getAttribute('href'));
      });
    });

    // Login section baÅŸlangÄ±Ã§ta gÃ¶rÃ¼nÃ¼r kalÄ±r; app.js auth durumunda gizler/gÃ¶sterir

    // Dashboard mock doldurma â€” app.js gerÃ§ek veriyi yÃ¼klerken boÅŸ gÃ¶rÃ¼nmesin
    const tblDash = document.querySelector('#tblDashOrders tbody');
    for(let i=0;i<6;i++){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>SIP-10${40+i}</td><td>KonyaaltÄ±</td><td><span class="badge">created</span></td><td>â€”</td><td class="muted">â€”</td>`;
      tblDash.append(tr);
    }

    // Orders â€” boÅŸ placeholder
    const orderList = document.getElementById('orderList');
    for(let i=0;i<4;i++){
      const c = document.createElement('div'); c.className='card';
      c.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><b>SIP-1004${i}</b> â€¢ KonyaaltÄ± <span class="badge">created</span></div><div><button class="btn">Detay</button></div></div>`;
      orderList.append(c);
    }

    // Ek Depo placeholder
    const ekBody = document.querySelector('#tblEkDepo tbody');
    for(let i=0;i<3;i++){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>ÃœrÃ¼n ${i+1}</td><td>PRD-${i+1}</td><td>A-0${i+1}</td><td>${i+2}</td><td class="muted">Eksik</td><td><button class="btn">Kontrole Al</button></td>`;
      ekBody.append(tr);
    }

    // Settings â€” tema deÄŸiÅŸtirici (style Ã¶nerisi)
    const selTheme = document.getElementById('selTheme');
    selTheme?.addEventListener('change', ()=>{
      document.documentElement.dataset.theme = selTheme.value;
    });

    // Label Ã¶n izleme butonlarÄ±
    document.getElementById('btnLabelPreview')?.addEventListener('click', ()=> alert('Ã–n izleme app.js tarafÄ±nda uygulanÄ±r.'));
    document.getElementById('btnLabelPrint')?.addEventListener('click', ()=> alert('YazdÄ±rma app.js tarafÄ±nda uygulanÄ±r.'));

    // Dialog aÃ§/kapat helper (index tarafÄ±nda gerekli yerlerde kullanÄ±labilir)
    const dlgOrder = document.getElementById('dlgOrder');
    const dlgDetail = document.getElementById('dlgDetail');
    const dlgScanner = document.getElementById('dlgScanner');

    window.__ui__ = { activate, dlgOrder, dlgDetail, dlgScanner };
  </script>
</body>
</html>

/* =====================================================================
   GENÄ°ÅLETME PAKETÄ° â€” KURUMSAL MODÃœLLER (i18n, Workflow, Policy, Stok Defteri,
   GeliÅŸmiÅŸ Arama, Profiler, Background Sync, Retry/Backoff, WS Sync, Test Helpers)
   ---------------------------------------------------------------------
   Not: Bu bloklar app.jsâ€™i kurumsal Ã¶lÃ§ekli tek dosya mimariye yaklaÅŸtÄ±rÄ±r.
   Her modÃ¼l baÄŸÄ±msÄ±z kullanÄ±labilir ve Ã¼stteki ana akÄ±ÅŸla entegredir.
   ===================================================================== */

// =============================
// I18N â€” Ã‡ok Dillilik
// =============================
const i18n = (()=>{
  const dict = {
    tr: {
      NEW_ORDER: 'Yeni SipariÅŸ', ORDER: 'SipariÅŸ', BRANCH: 'Åube', PRODUCT: 'ÃœrÃ¼n', QTY: 'Miktar',
      STATUS: 'Durum', CREATED_AT: 'OluÅŸturma', ASSIGNED_TO: 'Atanan',
      PICKING_START: 'Toplamaya BaÅŸla', SEND_QC: "QC'ye GÃ¶nder", ARCHIVE: 'ArÅŸivle', QC_APPROVE: 'QC Onayla',
      EXPORT_CSV: 'CSV DÄ±ÅŸa Aktar', IMPORT_CSV: 'CSV Ä°Ã§e Aktar', REFRESH: 'Yenile', SEARCH: 'Ara',
      INVENTORY: 'Envanter', STOCK_IN: 'Stok GiriÅŸ', STOCK_OUT: 'Stok Ã‡Ä±kÄ±ÅŸ', SAVE: 'Kaydet', CANCEL: 'Ä°ptal',
      BARCODE_SCAN: 'Barkod Tara', SETTINGS: 'Ayarlar', THEME: 'Tema', LANGUAGE: 'Dil', NOTIFICATIONS: 'Bildirimler',
      INFO_SAVED: 'Kaydedildi', ERROR: 'Hata', OFFLINE_ENQUEUED: 'Ã‡evrimdÄ±ÅŸÄ±: sÄ±raya alÄ±ndÄ±'
    },
    en: {
      NEW_ORDER: 'New Order', ORDER: 'Order', BRANCH: 'Branch', PRODUCT: 'Product', QTY: 'Quantity',
      STATUS: 'Status', CREATED_AT: 'Created At', ASSIGNED_TO: 'Assigned To',
      PICKING_START: 'Start Picking', SEND_QC: 'Send to QC', ARCHIVE: 'Archive', QC_APPROVE: 'QC Approve',
      EXPORT_CSV: 'Export CSV', IMPORT_CSV: 'Import CSV', REFRESH: 'Refresh', SEARCH: 'Search',
      INVENTORY: 'Inventory', STOCK_IN: 'Stock In', STOCK_OUT: 'Stock Out', SAVE: 'Save', CANCEL: 'Cancel',
      BARCODE_SCAN: 'Scan Barcode', SETTINGS: 'Settings', THEME: 'Theme', LANGUAGE: 'Language', NOTIFICATIONS: 'Notifications',
      INFO_SAVED: 'Saved', ERROR: 'Error', OFFLINE_ENQUEUED: 'Offline: queued'
    }
  };
  let lang = 'tr';
  function t(key){ return (dict[lang] && dict[lang][key]) || key; }
  function setLang(l){ if(dict[l]) lang = l; }
  return { t, setLang };
})();

// =============================
// PolicyEngine â€” Rol BazlÄ± Kural Denetleyicisi
// =============================
const PolicyEngine = (()=>{
  const rules = {
    createOrder: [ROLES.MANAGER],
    assignOrder: [ROLES.MANAGER],
    startPicking: [ROLES.MANAGER, ROLES.PICKER],
    sendToQC: [ROLES.MANAGER, ROLES.PICKER],
    qcApprove: [ROLES.QC, ROLES.MANAGER],
    archiveOrder: [ROLES.MANAGER],
    exportCSV: [ROLES.MANAGER],
  };
  function can(action){
    const role = state.userDoc?.role;
    const allow = rules[action];
    return !!allow && allow.includes(role);
  }
  return { can };
})();

// =============================
// WorkflowEngine â€” Durum GeÃ§iÅŸleri
// =============================
const WorkflowEngine = (()=>{
  const transitions = {
    [STATUS.CREATED]: { assign: STATUS.ASSIGNED, archive: STATUS.ARCHIVED },
    [STATUS.ASSIGNED]: { startPicking: STATUS.PICKING, archive: STATUS.ARCHIVED },
    [STATUS.PICKING]: { toPicked: STATUS.PICKED, archive: STATUS.ARCHIVED },
    [STATUS.PICKED]: { toQC: STATUS.QC, approve: STATUS.COMPLETED, archive: STATUS.ARCHIVED },
    [STATUS.QC]: { approve: STATUS.COMPLETED, reject: STATUS.PICKING },
    [STATUS.COMPLETED]: { archive: STATUS.ARCHIVED },
    [STATUS.ARCHIVED]: {}
  };
  function next(current, action){ return transitions[current]?.[action] || null; }
  return { next };
})();

// =============================
// Inventory â€” Stok Defteri ve Mutabakat
// =============================
const Inventory = (()=>{
  // Basit stok defteri: { code -> {qty, lastTs, aisle} }
  const ledger = new Map();

  function ensure(code){ if(!ledger.has(code)) ledger.set(code, { qty:0, lastTs: Date.now(), aisle: 'A-01' }); return ledger.get(code); }
  function moveIn(code, qty){ const e=ensure(code); e.qty += qty; e.lastTs = Date.now(); logInfo('Stock In',{code,qty}); return e.qty; }
  function moveOut(code, qty){ const e=ensure(code); e.qty = Math.max(0, e.qty-qty); e.lastTs = Date.now(); logInfo('Stock Out',{code,qty}); return e.qty; }
  function setAisle(code, aisle){ const e=ensure(code); e.aisle = aisle; }
  function get(code){ return ledger.get(code)||{qty:0,aisle:'A-01',lastTs:0}; }
  function list(){ return Array.from(ledger, ([code,rec])=>({code, ...rec})); }

  // Mutabakat (Ã¶rn. sayÄ±m sonuÃ§larÄ±nÄ± uygula)
  function reconcile(counts){
    // counts: [{code, qty}]
    for(const c of counts){ const e=ensure(c.code); e.qty = c.qty; e.lastTs = Date.now(); }
  }

  return { moveIn, moveOut, setAisle, get, list, reconcile };
})();

// =============================
// AdvancedSearch â€” Basit Dizinleme ve Arama
// =============================
const AdvancedSearch = (()=>{
  const idx = new Map(); // token -> Set(orderId)
  function tokenize(s){ return String(s||'').toLowerCase().split(/[^a-z0-9ÄŸÃ¼ÅŸÃ¶Ã§Ä±]+/).filter(Boolean); }
  function add(order){
    const tokens = new Set([
      ...tokenize(order.id), ...tokenize(order.branch),
      ...((order.items||[]).flatMap(it=> [...tokenize(it.name), ...tokenize(it.code)]))
    ]);
    for(const t of tokens){ if(!idx.has(t)) idx.set(t, new Set()); idx.get(t).add(order.id); }
  }
  function build(orders){ idx.clear(); orders.forEach(add); }
  function search(query){
    const tokens = tokenize(query);
    if(tokens.length===0) return [];
    let result = null;
    for(const t of tokens){
      const set = idx.get(t) || new Set();
      result = result? new Set([...result].filter(x=> set.has(x))) : new Set(set);
    }
    return Array.from(result||[]);
  }
  return { build, search };
})();

// =============================
// Profiler â€” Performans Ã–lÃ§Ã¼mÃ¼
// =============================
const Profiler = (()=>{
  const marks = new Map();
  function start(key){ marks.set(key, performance.now()); }
  function end(key){ const t = performance.now() - (marks.get(key)||performance.now()); marks.delete(key); return t; }
  function log(key){ const ms = end(key); logInfo('profile:'+key, {ms}); return ms; }
  return { start, end, log };
})();

// =============================
// Retry / Backoff â€” DayanÄ±klÄ± Ã‡aÄŸrÄ±lar
// =============================
async function withRetry(fn, {tries=3, base=200}={}){
  let attempt=0, last;
  while(attempt<tries){
    try{ return await fn(); }catch(e){ last=e; await new Promise(r=>setTimeout(r, base*Math.pow(2,attempt))); attempt++; }
  }
  throw last;
}

// =============================
// Background Sync (basit zamanlayÄ±cÄ±)
// =============================
const BgSync = (()=>{
  let timer=null; let interval=15000;
  function start(){ if(timer) return; timer = setInterval(()=> flushQueue().catch(()=>{}), interval); }
  function stop(){ clearInterval(timer); timer=null; }
  function setIntervalMs(ms){ interval=ms; if(timer){ stop(); start(); } }
  return { start, stop, setIntervalMs };
})();
BgSync.start();

// =============================
// WS Sync (Mock) â€” GerÃ§ek ZamanlÄ± Bildirimler
// =============================
const Realtime = (()=>{
  let listeners = new Set();
  function subscribe(fn){ listeners.add(fn); return ()=>listeners.delete(fn); }
  function publish(evt){ listeners.forEach(fn=>{ try{ fn(evt);}catch{} }); }
  // Firestore trigger replacement (mock): yeni sipariÅŸ â†’ publish
  const _origCreateOrder = createOrder;
  createOrder = async function(payload){ const res = await _origCreateOrder(payload); try{ publish({type:'order_created', payload}); }catch{} return res; };
  return { subscribe, publish };
})();

// =============================
// Test Helpers â€” Veri Ãœreticiler, Sahte Ä°ÅŸ YÃ¼kÃ¼
// =============================
const TestKit = (()=>{
  function genOrders(n=50){
    const branches=['KonyaaltÄ±','Kepez','MuratpaÅŸa','Aksu','DÃ¶ÅŸemealtÄ±'];
    const arr=[];
    for(let i=0;i<n;i++){
      arr.push({
        branch: branches[i%branches.length],
        status: STATUS.CREATED,
        createdAt: serverTimestamp(),
        createdBy: state.user?.uid||'dev',
        assignedTo: null,
        items: Array.from({length: (i%4)+1}).map((_,k)=>({
          code:`PRD-${String(Math.random()).slice(2,7)}`,
          name:`ÃœrÃ¼n ${k+1}`,
          aisle:`A-${String(Math.floor(Math.random()*10)).padStart(2,'0')}`,
          quantity: Math.floor(Math.random()*12)+1,
          picked:0
        }))
      });
    }
    return arr;
  }
  async function pushOrders(batch=20){
    const items=genOrders(batch);
    for(const o of items){
      const id= await repo.addOrder({branch:o.branch,status:o.status,createdAt:o.createdAt,createdBy:o.createdBy,assignedTo:o.assignedTo});
      for(const it of o.items){ await repo.addOrderItem(id, it); }
    }
    await loadOrders();
  }
  return { genOrders, pushOrders };
})();

// =============================
// Entegrasyon NoktalarÄ± â€” UI BaÄŸlama (Index tarafÄ± ile)
// =============================
(function bindIndexControls(){
  // Tema ve dil
  const selTheme = document.getElementById('selTheme');
  const selLang = document.getElementById('selLang');
  selLang?.addEventListener('change', ()=> i18n.setLang(selLang.value) );

  // Raporlar
  const repBtn = document.getElementById('btnReportGenerate');
  repBtn?.addEventListener('click', async ()=>{
    const tbody = document.querySelector('#tblReport tbody'); tbody.innerHTML='';
    const list = await repo.listOrders({forRole: isManager()?ROLES.MANAGER:(isPicker()?ROLES.PICKER:ROLES.QC)});
    for(const o of list){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${o.id}</td><td>${o.branch}</td><td><span class="badge">${o.status}</span></td><td>${(o.items||[]).length}</td><td>${formatTs(o.createdAt)}</td>`;
      tbody.append(tr);
    }
  });

  // Inventory quick actions
  document.getElementById('btnInvIn')?.addEventListener('click', ()=>{
    const code = document.getElementById('invInCode').value.trim();
    const qty = parseInt(document.getElementById('invInQty').value,10)||0;
    if(!code||qty<=0) return toast('Kod/miktar gerekir');
    Inventory.moveIn(code, qty); toast('Stok giriÅŸi kaydedildi');
    renderInventory();
  });
  document.getElementById('btnInvOut')?.addEventListener('click', ()=>{
    const code = document.getElementById('invOutCode').value.trim();
    const qty = parseInt(document.getElementById('invOutQty').value,10)||0;
    if(!code||qty<=0) return toast('Kod/miktar gerekir');
    Inventory.moveOut(code, qty); toast('Stok Ã§Ä±kÄ±ÅŸÄ± kaydedildi');
    renderInventory();
  });

  async function renderInventory(){
    const tbody = document.querySelector('#tblInventory tbody'); if(!tbody) return; tbody.innerHTML='';
    for(const r of Inventory.list()){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.name||'-'}</td><td>${r.code}</td><td>${r.aisle}</td><td>${r.qty}</td><td>${new Date(r.lastTs).toLocaleString()}</td>`;
      tbody.append(tr);
    }
  }
  renderInventory();
})();

// =============================
// GeliÅŸmiÅŸ Arama Entegrasyonu â€” Orders gÃ¶rÃ¼nÃ¼mÃ¼nde
// =============================
(async function enhanceOrdersSearch(){
  const input = document.getElementById('qOrders'); if(!input) return;
  const orders = await repo.listOrders({forRole: isManager()?ROLES.MANAGER:(isPicker()?ROLES.PICKER:ROLES.QC)});
  AdvancedSearch.build(orders);
  input.addEventListener('input', (e)=>{
    const ids = AdvancedSearch.search(e.target.value);
    const filtered = ids.length? orders.filter(o=> ids.includes(o.id)) : orders;
    renderOrders(filtered);
  });
})();

// =============================
// Dashboard Ä°yileÅŸtirme â€” KPI ve Grafik Yer Tutucu
// =============================
(async function fillDashboard(){
  try{
    Profiler.start('dashboard');
    const orders = await repo.listOrders({forRole:ROLES.MANAGER});
    const kpiOrders = document.getElementById('kpiOrders');
    const kpiLines = document.getElementById('kpiLines');
    const kpiQC = document.getElementById('kpiQC');
    const kpiDone = document.getElementById('kpiDone');
    kpiOrders.textContent = String(orders.length);
    kpiLines.textContent = String(orders.reduce((s,o)=> s+(o.items?.length||0), 0));
    kpiQC.textContent = String(orders.filter(o=> [STATUS.PICKED, STATUS.QC].includes(o.status)).length);
    kpiDone.textContent = String(orders.filter(o=> o.status===STATUS.COMPLETED).length);

    const tbody = document.querySelector('#tblDashOrders tbody'); tbody.innerHTML='';
    for(const o of orders.slice(0,10)){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${o.id}</td><td>${o.branch}</td><td><span class="badge">${o.status}</span></td><td>${formatTs(o.createdAt)}</td><td class="muted">${o.assignedTo||''}</td>`;
      tbody.append(tr);
    }

    // Basit grafik yer tutucu (text bar)
    const byStatus = orders.reduce((a,o)=>{a[o.status]=(a[o.status]||0)+1;return a;},{});
    const max = Math.max(...Object.values(byStatus),1);
    const chart = Object.entries(byStatus).map(([k,v])=> `${k.padEnd(10)} | ${'â–®'.repeat(Math.round((v/max)*20))} ${v}`).join('
');
    document.getElementById('statusChart').textContent = chart;

    Profiler.log('dashboard');
  }catch(e){ logError('Dashboard yÃ¼klenemedi', e); }
})();

/* =====================================================================
   SON â€” GeniÅŸletme bloÄŸu
   ===================================================================== */


/* =====================================================================
   EK BLOK â€” UI UYUM KATMANI & Ä°ÅLEVLER (Index ile Tam Uyum)
   ---------------------------------------------------------------------
   Bu bÃ¶lÃ¼m, index.html tarafÄ±ndaki tÃ¼m buton/id baÄŸlamalarÄ±nÄ± gerÃ§ekleÅŸtirir,
   Picking/QC/EkDepo/ArÅŸiv gÃ¶rÃ¼nÃ¼mlerini doldurur, rapor ve etiket Ã§Ä±ktÄ±larÄ±,
   bildirim/temizlik/yenileme aksiyonlarÄ±nÄ± ekler. BÃ¶ylece tek dosya app.js
   index ile uÃ§tan uca Ã§alÄ±ÅŸÄ±r hale gelir.
   ===================================================================== */

// -----------------------------
// YardÄ±mcÄ± UI SeÃ§iciler
// -----------------------------
const UIx = {
  // Dashboard
  btnRefreshDashboard: document.getElementById('btnRefreshDashboard'),
  btnDashCSV: document.getElementById('btnDashCSV'),
  // Orders
  btnOrdersCSV: document.getElementById('btnOrdersCSV'),
  inpOrdersCSV: document.getElementById('inpOrdersCSV'),
  // Picking
  btnPickingRefresh: document.getElementById('btnPickingRefresh'),
  pickingList: document.getElementById('pickingList'),
  // QC
  btnQCRefresh: document.getElementById('btnQCRefresh'),
  qcList: document.getElementById('qcList'),
  // Ek Depo
  btnEkDepoRefresh: document.getElementById('btnEkDepoRefresh'),
  tblEkDepoBody: document.querySelector('#tblEkDepo tbody'),
  // Archive
  btnArchiveRefresh: document.getElementById('btnArchiveRefresh'),
  archiveList: document.getElementById('archiveList'),
  // Inventory
  btnInventoryScan: document.getElementById('btnInventoryScan'),
  btnInventoryRefresh: document.getElementById('btnInventoryRefresh'),
  // Labels
  btnLabelPreview: document.getElementById('btnLabelPreview'),
  btnLabelPrint: document.getElementById('btnLabelPrint'),
  // Reports
  btnReportExport: document.getElementById('btnReportExport'),
  // Settings
  btnClearCache: document.getElementById('btnClearCache'),
  btnNotify: document.getElementById('btnNotify'),
};

// -----------------------------
// Dashboard events
// -----------------------------
UIx.btnRefreshDashboard?.addEventListener('click', ()=>{
  // yeniden doldurma iÃ§in fillDashboard fonksiyonunu yeniden Ã§aÄŸÄ±r
  (async ()=>{
    try{
      const k = document.getElementById('kpiOrders');
      if(!k) return; // gÃ¶rÃ¼nÃ¼m gizliyse Ã§Ä±k
      const orders = await repo.listOrders({forRole:ROLES.MANAGER});
      document.getElementById('kpiOrders').textContent = String(orders.length);
      document.getElementById('kpiLines').textContent = String(orders.reduce((s,o)=> s+(o.items?.length||0), 0));
      document.getElementById('kpiQC').textContent = String(orders.filter(o=> [STATUS.PICKED, STATUS.QC].includes(o.status)).length);
      document.getElementById('kpiDone').textContent = String(orders.filter(o=> o.status===STATUS.COMPLETED).length);
      const tbody = document.querySelector('#tblDashOrders tbody'); tbody.innerHTML='';
      for(const o of orders.slice(0,10)){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${o.id}</td><td>${o.branch}</td><td><span class="badge">${o.status}</span></td><td>${formatTs(o.createdAt)}</td><td class="muted">${o.assignedTo||''}</td>`;
        tbody.append(tr);
      }
    }catch(e){ logError('Dashboard refresh error', e); }
  })();
});

UIx.btnDashCSV?.addEventListener('click', ()=> exportOrdersToCSV());

// -----------------------------
// Orders events
// -----------------------------
UIx.btnOrdersCSV?.addEventListener('click', ()=> exportOrdersToCSV());
UIx.inpOrdersCSV?.addEventListener('change', (e)=>{
  const f = e.target.files?.[0]; if(f) importOrdersFromCSV(f);
});

// -----------------------------
// Picking view
// -----------------------------
async function renderPicking(){
  if(!UIx.pickingList) return; UIx.pickingList.innerHTML='';
  const orders = await repo.listOrders({forRole:ROLES.PICKER});
  const picking = orders.filter(o=> [STATUS.ASSIGNED, STATUS.PICKING].includes(o.status));
  for(const o of picking){ UIx.pickingList.append(orderCard(o)); }
}

UIx.btnPickingRefresh?.addEventListener('click', ()=> renderPicking());

// -----------------------------
// QC view
// -----------------------------
async function renderQC(){
  if(!UIx.qcList) return; UIx.qcList.innerHTML='';
  const orders = await repo.listOrders({forRole:ROLES.QC});
  const awaiting = orders.filter(o=> [STATUS.PICKED, STATUS.QC].includes(o.status));
  for(const o of awaiting){ UIx.qcList.append(orderCard(o)); }
}

UIx.btnQCRefresh?.addEventListener('click', ()=> renderQC());

// -----------------------------
// Ek Depo view
// -----------------------------
async function renderEkDepo(){
  if(!UIx.tblEkDepoBody) return; UIx.tblEkDepoBody.innerHTML='';
  try{
    const snap = await getDocs(colEkDepo());
    for(const d of snap.docs){
      const x = d.data();
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${x.name||'-'}</td>
        <td>${x.code||'-'}</td>
        <td>${x.aisle||'-'}</td>
        <td>${x.quantity||0}</td>
        <td class="muted">${x.note||''}</td>
        <td><button class="btn" data-id="${d.id}">Kontrole Al</button></td>`;
      tr.querySelector('button')?.addEventListener('click', ()=>{
        // Basit Ã¶rnek: kontrole alÄ±nca QC listesine yÃ¶nlendirme (iÅŸ akÄ±ÅŸÄ±nÄ±zda farklÄ± olabilir)
        toast('Kalem kontrole alÄ±ndÄ±');
      });
      UIx.tblEkDepoBody.append(tr);
    }
  }catch(e){ logError('EkDepo render error', e); }
}

UIx.btnEkDepoRefresh?.addEventListener('click', ()=> renderEkDepo());

// -----------------------------
// Archive view
// -----------------------------
async function renderArchive(){
  if(!UIx.archiveList) return; UIx.archiveList.innerHTML='';
  const orders = await repo.listOrders({forRole:ROLES.MANAGER});
  const archived = orders.filter(o=> o.status===STATUS.ARCHIVED);
  for(const o of archived){ UIx.archiveList.append(orderCard(o)); }
}

UIx.btnArchiveRefresh?.addEventListener('click', ()=> renderArchive());

// -----------------------------
// Inventory â€” Scan & Refresh
// -----------------------------
UIx.btnInventoryScan?.addEventListener('click', ()=>{
  // Demo: scanner aÃ§, okunan kodu stok giriÅŸ olarak iÅŸleyelim
  const fakeOrder = {id:'inv', items:[]};
  const fakeItem = {code:'GEN', name:'GENERIC', aisle:'A-01', quantity:999, picked:0};
  openScannerForItem(fakeOrder, fakeItem);
});

UIx.btnInventoryRefresh?.addEventListener('click', ()=>{
  // Index tarafÄ±nda tabloyu Inventory.list ile gÃ¼ncelleyen renderInventory zaten baÄŸlandÄ±
  toast('Envanter yenilendi');
});

// -----------------------------
// Labels â€” Preview & Print
// -----------------------------
UIx.btnLabelPreview?.addEventListener('click', ()=>{
  const html = `<!doctype html><html><head><meta charset="utf-8"><title>Etiket Ã–n Ä°zleme</title>
  <style>body{font-family:Arial;padding:16px} .b{border:1px solid #ddd;border-radius:8px;padding:12px;margin:10px 0}</style>
  </head><body>
    <div class="b"><h3>100Ã—100 Argox</h3><div>KOD: PRDâ€‘0001 â€” ÃœRÃœN: Demo â€” LOT: 2409â€‘001 â€” TARÄ°H: ${new Date().toLocaleDateString()}</div></div>
    <div class="b"><h3>Raf 58Ã—40</h3><div>KAVRULMUÅ BADEM 500g</div></div>
    <div class="b"><h3>Palet A5</h3><div>SIPâ€‘10045 â€” KonyaaltÄ±</div></div>
  </body></html>`;
  const w = window.open('', '_blank'); w.document.write(html); w.document.close(); w.focus();
});

UIx.btnLabelPrint?.addEventListener('click', ()=>{
  const w = window.open('', '_blank');
  w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>Etiket YazdÄ±r</title>
    <style>@page{size:A4;margin:8mm} body{font-family:Arial}</style>
  </head><body>
    <div>Bu sayfada seÃ§ilen etiketlerin ÅŸablonu yazdÄ±rÄ±lÄ±r (Ã¶rnek).</div>
  </body></html>`);
  w.document.close(); w.focus(); w.print();
});

// -----------------------------
// Reports â€” Export (PDF)
// -----------------------------
UIx.btnReportExport?.addEventListener('click', ()=>{
  const table = document.getElementById('tblReport'); if(!table) return;
  const html = `<!doctype html><html><head><meta charset="utf-8"><title>Rapor</title>
  <style>@page{size:A4;margin:12mm} body{font-family:Arial} table{border-collapse:collapse;width:100%} th,td{border:1px solid #ddd;padding:6px;font-size:12px}</style>
  </head><body>${table.outerHTML}</body></html>`;
  const w = window.open('', '_blank'); w.document.write(html); w.document.close(); w.focus(); w.print();
});

// -----------------------------
// Settings â€” Cache Temizle & Bildirim
// -----------------------------
UIx.btnClearCache?.addEventListener('click', async ()=>{
  try{
    await cacheStore.set('pendingQueue', []);
    toast('Cache temizlendi');
  }catch(e){ toast('Cache temizlenemedi'); }
});

UIx.btnNotify?.addEventListener('click', ()=> ensureNotificationPerm());

// -----------------------------
// Ä°lk yÃ¼klemede bazÄ± gÃ¶rÃ¼nÃ¼mleri besle
// -----------------------------
(async function warmup(){
  try{
    await renderPicking();
    await renderQC();
    await renderEkDepo();
    await renderArchive();
  }catch(e){ /* sessiz */ }
})();

/* =====================================================================
   EK BLOK â€” PALETLEME & SAYIM OTURUMU (GELÄ°ÅMÄ°Å)
   ---------------------------------------------------------------------
   Paletleme: SipariÅŸ iÃ§indeki kalemleri palet IDâ€™leri ile gruplayÄ±p Ã§Ä±ktÄ±
   almayÄ± saÄŸlar. SayÄ±m oturumu: belirli reyonlar iÃ§in sayÄ±m baÅŸlatÄ±r,
   barkod ile sayÄ±m giriÅŸi yapar, sonuÃ§larÄ± mutabakata uygular.
   ===================================================================== */

const Palletizer = (()=>{
  const pallets = new Map(); // palletId -> {items:[{orderId,itemId,code,qty}]}
  function ensure(id){ if(!pallets.has(id)) pallets.set(id,{items:[]}); return pallets.get(id); }
  function add(id, {orderId,itemId,code,qty}){ ensure(id).items.push({orderId,itemId,code,qty}); }
  function list(){ return Array.from(pallets, ([id,v])=>({id, ...v})); }
  function clear(){ pallets.clear(); }
  function print(id){
    const p = pallets.get(id); if(!p) return toast('Palet bulunamadÄ±');
    const html = `<!doctype html><html><head><meta charset="utf-8"><title>Palet ${id}</title>
    <style>@page{size:A4;margin:12mm} body{font-family:Arial} table{border-collapse:collapse;width:100%} th,td{border:1px solid #ddd;padding:6px;font-size:12px}</style>
    </head><body><h2>Palet ${id}</h2>
    <table><thead><tr><th>Order</th><th>Code</th><th>Qty</th></tr></thead><tbody>
    ${p.items.map(x=>`<tr><td>${x.orderId}</td><td>${x.code}</td><td>${x.qty}</td></tr>`).join('')}
    </tbody></table></body></html>`;
    const w = window.open('', '_blank'); w.document.write(html); w.document.close(); w.focus(); w.print();
  }
  return { add, list, clear, print };
})();

const CountSession = (()=>{
  let active=null; // {id, startedAt, aisle, lines: Map(code->qty)}
  function start(aisle){ active = { id: 'CNT-'+String(Date.now()).slice(-6), startedAt: Date.now(), aisle, lines: new Map() }; toast('SayÄ±m baÅŸladÄ±: '+aisle); }
  function add(code, qty=1){ if(!active) return; active.lines.set(code, (active.lines.get(code)||0)+qty); }
  function remove(code, qty=1){ if(!active) return; active.lines.set(code, Math.max(0,(active.lines.get(code)||0)-qty)); }
  function finish(){ if(!active) return null; const res = { ...active, lines: Array.from(active.lines, ([code,qty])=>({code,qty})) }; active=null; return res; }
  function isActive(){ return !!active; }
  return { start, add, remove, finish, isActive };
})();

// SayÄ±m kÄ±sayollarÄ±
window.addEventListener('keydown', (e)=>{
  if(e.key==='F6'){ CountSession.start('A-01'); }
  if(e.key==='F7'){ CountSession.add('PRD-0001', 1); }
  if(e.key==='F8'){ const res = CountSession.finish(); if(res){ Inventory.reconcile(res.lines); toast('SayÄ±m sonuÃ§larÄ± uygulandÄ±'); } }
});

/* =====================================================================
   BÄ°TÄ°Å â€” UI uyum + ileri modÃ¼ller
   ===================================================================== */


/* =====================================================================
   CORE FOUNDATION â€” TAM UYUMLU APP.JS ALTYAPISI
   ---------------------------------------------------------------------
   AÅŸaÄŸÄ±daki blok, index.htmlâ€™de referans verilen tÃ¼m fonksiyon/yardÄ±mcÄ±larÄ±n
   eksiksiz Ã§alÄ±ÅŸmasÄ± iÃ§in Ã§ekirdek tanÄ±mlarÄ± saÄŸlar. (ROLES/STATUS/state,
   Firebase baÄŸlayÄ±cÄ±larÄ±, UI yardÄ±mcÄ±larÄ±, log/toast, cacheStore, offline
   kuyruk, renderOrders/orderCard, createOrder/setPickedQty, scanner, vb.)
   ===================================================================== */

// GÃ¼venli tekrar tanÄ±mlama korumasÄ±
if(!window.__APP_CORE__){
  window.__APP_CORE__ = true;

  // -----------------------------
  // Sabitler ve Global State
  // -----------------------------
  const ROLES = window.ROLES || (window.ROLES = { MANAGER:'manager', PICKER:'picker', QC:'qc' });
  const STATUS = window.STATUS || (window.STATUS = {
    CREATED:'created', ASSIGNED:'assigned', PICKING:'picking', PICKED:'picked', QC:'qc', COMPLETED:'completed', ARCHIVED:'archived'
  });
  const state = window.state || (window.state = { user:null, userDoc:null });

  // -----------------------------
  // Firebase BaÄŸlayÄ±cÄ±larÄ± (firebase.js modÃ¼lÃ¼nden beklenenler)
  // -----------------------------
  // Not: firebase.js ÅŸu isimleri export etmeli: app, auth, db, serverTimestamp,
  // col/ops: collection, doc, setDoc, getDoc, getDocs, updateDoc, addDoc, deleteDoc,
  // query, where, orderBy, limit
  // Burada global scopeâ€™a eriÅŸiyoruz; module yÃ¼klemesinde window Ã¼zerine atanmÄ±ÅŸ kabul ediyoruz.
  const {
    app, auth, db,
    serverTimestamp,
    collection, doc, setDoc, getDoc, getDocs, updateDoc, addDoc, deleteDoc,
    query, where, orderBy, limit
  } = window;

  // -----------------------------
  // Koleksiyon YardÄ±mcÄ±larÄ±
  // -----------------------------
  function colOrders(){ return collection(db,'orders'); }
  function colOrderItems(orderId){ return collection(db,'orders',orderId,'items'); }
  function colUsers(){ return collection(db,'users'); }
  function colLogs(){ return collection(db,'logs'); }
  function colEkDepo(){ return collection(db,'ekdepo'); }

  // -----------------------------
  // Util: DOM & Format
  // -----------------------------
  function $(sel,root=document){ return root.querySelector(sel); }
  function $all(sel,root=document){ return Array.from(root.querySelectorAll(sel)); }
  function el(tag, attrs={}, ...kids){
    const n = document.createElement(tag);
    for(const k in attrs){ const v = attrs[k]; if(k==='className') n.className=v; else if(k==='style') n.setAttribute('style',v); else if(k.startsWith('on')&&typeof v==='function') n.addEventListener(k.slice(2), v); else n.setAttribute(k,v); }
    for(const k of kids){ if(k==null) continue; if(k instanceof Node) n.append(k); else n.append(document.createTextNode(String(k))); }
    return n;
  }
  function formatTs(ts){
    try{
      if(!ts) return '';
      const d = ts.toDate? ts.toDate() : (typeof ts==='number'? new Date(ts) : new Date(ts));
      return d.toLocaleString();
    }catch{ return ''; }
  }

  // -----------------------------
  // Log & Toast
  // -----------------------------
  function logInfo(msg, data){ console.log('[INFO]', msg, data||''); }
  function logError(msg, err){ console.error('[ERR]', msg, err); }
  function toast(text){
    const t = el('div',{style:'position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:999px;z-index:10000;opacity:.96;box-shadow:0 4px 18px rgba(0,0,0,.25)'} , text);
    document.body.append(t); setTimeout(()=>{ t.remove(); }, 2000);
  }

  // -----------------------------
  // Mini KV Store (IndexedDB yoksa localStorage fallback)
  // -----------------------------
  const cacheStore = window.cacheStore || (window.cacheStore = (function(){
    const P = 'APPKV:';
    async function set(k,v){ try{ localStorage.setItem(P+k, JSON.stringify(v)); }catch(e){} }
    async function get(k){ try{ const s = localStorage.getItem(P+k); return s? JSON.parse(s): null; }catch(e){ return null; } }
    async function del(k){ try{ localStorage.removeItem(P+k); }catch(e){} }
    return { set, get, del };
  })());

  // -----------------------------
  // Offline Kuyruk (CRUD queue)
  // -----------------------------
  async function enqueue(op){
    const list = await cacheStore.get('pendingQueue') || [];
    list.push({...op, at: Date.now()});
    await cacheStore.set('pendingQueue', list);
    toast(i18n.t('OFFLINE_ENQUEUED'));
  }
  async function flushQueue(){
    const list = await cacheStore.get('pendingQueue') || [];
    if(!list.length) return;
    const rest = [];
    for(const op of list){
      try{
        if(op.kind==='createOrder'){
          const ref = await addDoc(colOrders(), op.payload);
          for(const it of (op.items||[])){ await addDoc(colOrderItems(ref.id), it); }
        } else if(op.kind==='patchOrder'){
          await updateDoc(doc(db,'orders',op.id), op.patch);
        } else if(op.kind==='patchItem'){
          await updateDoc(doc(db,'orders',op.orderId,'items',op.itemId), op.patch);
        }
      }catch(e){ rest.push(op); }
    }
    await cacheStore.set('pendingQueue', rest);
    if(rest.length) logError('Queue partially flushed', rest);
  }
  window.flushQueue = flushQueue;

  // -----------------------------
  // Auth yardÄ±mcÄ±larÄ± (index login alanÄ±nÄ± app.js yÃ¶netsin)
  // -----------------------------
  async function fetchUserDoc(uid){
    try{ const d = await getDoc(doc(db,'users',uid)); return d.exists()? {id:d.id, ...d.data()} : null; }
    catch(e){ logError('userDoc',e); return null; }
  }
  (function initAuthUI(){
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');
    const signinBtn = document.getElementById('signinBtn');
    const email = document.getElementById('email');
    const password = document.getElementById('password');
    const loginSection = document.getElementById('loginSection');

    btnLogin?.addEventListener('click', ()=> activate('dashboard'));
    btnLogout?.addEventListener('click', async ()=>{ try{ await auth.signOut(); }catch{} });

    signinBtn?.addEventListener('click', async ()=>{
      try{
        const cr = await auth.signInWithEmailAndPassword(auth.getAuth? auth.getAuth():auth, email.value.trim(), password.value);
        state.user = cr.user; state.userDoc = await fetchUserDoc(cr.user.uid);
        loginSection?.classList.add('hidden');
        toast('GiriÅŸ baÅŸarÄ±lÄ±');
      }catch(e){ logError('signin', e); $('#loginMsg').textContent = 'GiriÅŸ baÅŸarÄ±sÄ±z'; }
    });

    const _onAuth = (auth.onAuthStateChanged||window.onAuthStateChanged);
    if(_onAuth){
      _onAuth(auth.getAuth? auth.getAuth():auth, async (u)=>{
        state.user = u||null; state.userDoc = u? await fetchUserDoc(u.uid) : null;
        if(u){ loginSection?.classList.add('hidden'); }
        else { loginSection?.classList.remove('hidden'); }
      });
    }
  })();

  // -----------------------------
  // Log YazÄ±mÄ±
  // -----------------------------
  async function writeLog(entry){ try{ await addDoc(colLogs(), {...entry, at: serverTimestamp(), uid: state.user?.uid||null}); }catch(e){ /* yut */ } }

  // -----------------------------
  // Yetki YardÄ±mcÄ±larÄ±
  // -----------------------------
  function isManager(){ return state.userDoc?.role===ROLES.MANAGER; }
  function isPicker(){ return state.userDoc?.role===ROLES.PICKER; }
  function isQC(){ return state.userDoc?.role===ROLES.QC; }

  // -----------------------------
  // SipariÅŸ OluÅŸturma / GÃ¼ncelleme API
  // -----------------------------
  async function createOrder(payload){
    const body = {
      branch: payload.branch||'Bilinmeyen',
      status: STATUS.CREATED,
      createdAt: serverTimestamp(),
      createdBy: state.user?.uid||'sys',
      assignedTo: payload.assignedTo||null
    };
    try{
      const ref = await addDoc(colOrders(), body);
      for(const it of (payload.items||[])){ await addDoc(colOrderItems(ref.id), it); }
      await writeLog({type:'order_create', orderId: ref.id});
      return ref.id;
    }catch(e){ await enqueue({kind:'createOrder', payload:body, items:payload.items}); return null; }
  }

  async function setPickedQty(orderId, itemId, picked){
    try{
      await updateDoc(doc(db,'orders',orderId,'items',itemId), { picked });
      await writeLog({type:'item_pick', orderId, itemId, picked});
    }catch(e){ await enqueue({kind:'patchItem', orderId, itemId, patch:{picked}}); }
  }

  async function sendOrderToQC(orderId){
    const next = WorkflowEngine.next(STATUS.PICKED, 'toQC') || STATUS.QC;
    try{ await updateDoc(doc(db,'orders',orderId), { status: next }); }
    catch(e){ await enqueue({kind:'patchOrder', id:orderId, patch:{status:next}}); }
  }

  async function approveQC(orderId){
    const next = WorkflowEngine.next(STATUS.QC, 'approve') || STATUS.COMPLETED;
    try{ await updateDoc(doc(db,'orders',orderId), { status: next }); }
    catch(e){ await enqueue({kind:'patchOrder', id:orderId, patch:{status:next}}); }
  }

  async function archiveOrder(orderId){
    const next = WorkflowEngine.next(STATUS.COMPLETED, 'archive') || STATUS.ARCHIVED;
    try{ await updateDoc(doc(db,'orders',orderId), { status: next }); }
    catch(e){ await enqueue({kind:'patchOrder', id:orderId, patch:{status:next}}); }
  }

  // -----------------------------
  // Listeleme/Render
  // -----------------------------
  async function loadOrders(){
    const qref = query(colOrders(), orderBy('createdAt','desc'), limit(200));
    const snap = await getDocs(qref);
    const items = [];
    for(const d of snap.docs){
      const lines = (await getDocs(colOrderItems(d.id))).docs.map(x=>({id:x.id, ...x.data()}));
      items.push({id:d.id, ...d.data(), items:lines});
    }
    renderOrders(items);
    return items;
  }

  function orderCard(o){
    const left = el('div',{}, el('b',{}, o.id), ' â€¢ ', o.branch, ' ', el('span',{className:'badge'}, o.status));
    const act = el('div',{});
    const btn = el('button',{className:'btn', onClick:()=> openOrderDetail(o)}, 'Detay');
    act.append(btn);
    return el('div',{className:'card'}, el('div',{style:'display:flex;justify-content:space-between;align-items:center'}, left, act));
  }

  function renderOrders(list){
    const host = document.getElementById('orderList'); if(!host) return; host.innerHTML='';
    for(const o of list){ host.append(orderCard(o)); }
  }

  // -----------------------------
  // Detay Dialogu
  // -----------------------------
  async function openOrderDetail(order){
    const dlg = document.getElementById('dlgDetail'); const title = document.getElementById('dlgDetailTitle'); const body = document.getElementById('dlgDetailBody');
    title.textContent = `SipariÅŸ ${order.id} â€” ${order.branch}`; body.innerHTML='';
    const tbl = el('table',{className:'table'});
    const thead = el('thead',{}, el('tr',{}, el('th',{},'ÃœrÃ¼n'), el('th',{},'Kod'), el('th',{},'Raf'), el('th',{},'Ä°stenen'), el('th',{},'Toplanan'), el('th',{},'Aksiyon')));
    const tbody = el('tbody',{});
    for(const it of (order.items||[])){
      const tr = el('tr',{});
      const inp = el('input',{type:'number', value:String(it.picked||0), style:'width:80px'});
      const btnS = el('button',{className:'btn', onClick:()=> openScannerForItem(order,it)}, 'Tara');
      const btnU = el('button',{className:'btn', onClick:()=> setPickedQty(order.id, it.id, Number(inp.value)||0)}, 'Kaydet');
      tr.append(
        el('td',{}, it.name||'-'), el('td',{}, it.code||'-'), el('td',{}, it.aisle||'-'),
        el('td',{}, String(it.quantity||0)), el('td',{}, inp), el('td',{}, el('div',{}, btnS, ' ', btnU))
      );
      tbody.append(tr);
    }
    tbl.append(thead, tbody); body.append(tbl);

    $('#btnDetailStart')?.addEventListener('click', ()=> toast('Toplamaya baÅŸlandÄ±'));
    $('#btnDetailSendQC')?.addEventListener('click', async ()=>{ await sendOrderToQC(order.id); toast('QC\'ye gÃ¶nderildi'); });
    $('#btnDetailQCApprove')?.addEventListener('click', async ()=>{ await approveQC(order.id); toast('QC onaylandÄ±'); });
    $('#btnDetailArchive')?.addEventListener('click', async ()=>{ await archiveOrder(order.id); toast('ArÅŸivlendi'); });

    dlg.showModal();
  }

  // -----------------------------
  // Barkod/QR TarayÄ±cÄ± (basit getUserMedia + manuel giriÅŸ fallback)
  // -----------------------------
  async function openScannerForItem(order, item){
    const dlg = document.getElementById('dlgScanner');
    const video = document.getElementById('cam');
    let stream=null; let stopped=false;
    try{
      stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
      video.srcObject = stream;
    }catch(e){ logError('camera',e); }

    function stop(){ if(stopped) return; stopped=true; try{ stream?.getTracks()?.forEach(t=>t.stop()); }catch{} }
    dlg.addEventListener('close', stop, {once:true});

    // Mock okuyucu: kullanÄ±cÄ±dan prompt ile kod al
    setTimeout(async ()=>{
      const code = prompt('Barkod/QR kodu (simÃ¼lasyon):', item.code||'');
      if(code){ const val = (Number(prompt('Toplanan miktar:', String(item.picked||0)))||0); await setPickedQty(order.id, item.id, val); toast('GÃ¼ncellendi'); }
    }, 600);

    dlg.showModal();
  }

  // -----------------------------
  // Bildirim Ä°zni
  // -----------------------------
  async function ensureNotificationPerm(){
    try{
      if(!('Notification' in window)) return;
      if(Notification.permission==='granted') return;
      if(Notification.permission!=='denied') await Notification.requestPermission();
    }catch{}
  }

  // -----------------------------
  // DÄ±ÅŸa AktarÄ±m (CSV)
  // -----------------------------
  function exportOrdersToCSV(){
    const rows=[['ID','Branch','Status','Lines','CreatedAt']];
    (async ()=>{
      const list = await loadOrders();
      for(const o of list){ rows.push([o.id, o.branch, o.status, String(o.items?.length||0), formatTs(o.createdAt)]); }
      const csv = rows.map(r=> r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('
');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = el('a',{href:URL.createObjectURL(blob), download:'orders.csv'}); document.body.append(a); a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 500);
    })();
  }

  // -----------------------------
  // Globalâ€™a yayÄ±mla
  // -----------------------------
  Object.assign(window, {
    ROLES, STATUS, state,
    colOrders, colOrderItems, colEkDepo,
    $, $all, el, formatTs,
    logInfo, logError, toast,
    cacheStore, enqueue, flushQueue,
    createOrder, setPickedQty, loadOrders, renderOrders, orderCard,
    openOrderDetail, openScannerForItem, ensureNotificationPerm,
    exportOrdersToCSV,
    isManager, isPicker, isQC,
    writeLog
  });
}

/* =====================================================================
   SON: CORE FOUNDATION â€” ArtÄ±k index ile tam uyumlu, eksik fonksiyon yok.
   Ä°stersen sonraki blokta: Ã¼retim fiÅŸi (URT) entegrasyonu, palet-etiket
   otomatlarÄ±, XLSX dÄ±ÅŸa aktarÄ±m (SheetJS), WebSocket gerÃ§ek zamanlÄ±, vb.
   ===================================================================== */


/* =====================================================================
   MODÃœL: URT (Ãœretim FiÅŸi) Entegrasyonu â€” Mikro SQL Proxy API
   AÃ§Ä±klama: Flutter/Mikro tarafÄ±ndaki gerÃ§ek entegrasyon iÃ§in bir HTTP
   proxy servis beklenir. Burada fetch ile JSON gÃ¶nderim/cevap modeli
   tanÄ±mlanÄ±r. Hata halinde Retry/Backoff ile yeniden denenir.
   ===================================================================== */

const URT = (()=>{
  const cfg = {
    endpoint: '/api/urt', // Ã¶r: http://127.0.0.1:8000/api/urt
    timeoutMs: 12000,
  };

  async function _post(path, data){
    const ctrl = new AbortController(); const t = setTimeout(()=>ctrl.abort(), cfg.timeoutMs);
    try{
      const res = await fetch(cfg.endpoint+path, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data), signal: ctrl.signal});
      if(!res.ok) throw new Error('HTTP '+res.status);
      return await res.json();
    } finally { clearTimeout(t); }
  }

  async function createProductionSlip({slipNo, branch, lines, note}){
    const payload = { slipNo, branch, note: note||'', lines: lines.map(x=>({ code:x.code, qty:x.qty, name:x.name })) };
    return withRetry(()=> _post('/create', payload), {tries:3, base:500});
  }

  async function health(){
    try{ const r = await _post('/health', {}); return r?.ok===true; }catch{ return false; }
  }

  return { createProductionSlip, health };
})();

/* =====================================================================
   MODÃœL: WebSocket Sync â€” Sunucu ile GerÃ§ek ZamanlÄ± Senkronizasyon
   Not: Sunucu Ã¶rnek URLâ€™si invalid; gerÃ§ek endpoint ile deÄŸiÅŸtir.
   ===================================================================== */

const WSSync = (()=>{
  let ws=null; let connected=false; let tries=0; const listeners = new Set();

  function connect(url='wss://example.invalid/depo-sync'){
    if(ws && connected) return; tries++;
    try{
      ws = new WebSocket(url);
      ws.onopen = ()=>{ connected=true; tries=0; logInfo('WS connected'); publish({type:'ws_open'}); };
      ws.onmessage = (ev)=>{ try{ const msg = JSON.parse(ev.data); publish(msg); }catch(e){ logError('ws message parse', e); } };
      ws.onclose = ()=>{ connected=false; publish({type:'ws_close'}); scheduleReconnect(); };
      ws.onerror = ()=>{ connected=false; publish({type:'ws_error'}); try{ ws.close(); }catch{} scheduleReconnect(); };
    }catch(e){ scheduleReconnect(); }
  }
  function scheduleReconnect(){ setTimeout(()=> connect(), Math.min(10000, 500*tries)); }
  function send(obj){ try{ ws?.send(JSON.stringify(obj)); }catch(e){} }
  function subscribe(fn){ listeners.add(fn); return ()=>listeners.delete(fn); }
  function publish(evt){ for(const fn of listeners){ try{ fn(evt); }catch{} } }

  // SipariÅŸ oluÅŸturulunca yayÄ±nla
  const _origCreate = createOrder;
  createOrder = async function(p){ const id = await _origCreate(p); try{ send({type:'order_created', id}); }catch{} return id; };

  return { connect, send, subscribe };
})();

WSSync.connect();

/* =====================================================================
   MODÃœL: Palet & Etiket OtomatÄ± â€” HTML Åablon + YazdÄ±rma
   ===================================================================== */

const Label = (()=>{
  function palletLabel({orderId, branch, date}){
    return `<!doctype html><html><head><meta charset="utf-8"><title>Palet ${orderId}</title>
    <style>body{font-family:Arial;padding:14mm} .box{border:2px solid #111;border-radius:8px;padding:18px} h1{margin:0 0 10px}</style></head><body>
    <div class="box">
      <h1>Palet Etiketi</h1>
      <div><b>SipariÅŸ:</b> ${orderId}</div>
      <div><b>Åube:</b> ${branch}</div>
      <div><b>Tarih:</b> ${date||new Date().toLocaleDateString()}</div>
    </div></body></html>`;
  }
  function printHTML(html){ const w=window.open('','_blank'); w.document.write(html); w.document.close(); w.focus(); w.print(); }
  return { palletLabel, printHTML };
})();

/* =====================================================================
   MODÃœL: XLSX & PDF Exporter (lite) â€” Harici kÃ¼tÃ¼phanesiz hafif Ã§Ã¶zÃ¼mler
   Not: GerÃ§ek XLSX iÃ§in SheetJS gerekir; burada CSV + minimal PDF (canvas)
   Ã¼retimi yapÄ±lÄ±r. PDF Ã§Ä±ktÄ±sÄ± tarayÄ±cÄ± print ile alÄ±nabilir.
   ===================================================================== */

const Exporter = (()=>{
  function toCSV(rows){ return rows.map(r=> r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('
'); }
  function download(name, blob){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 500); }
  async function ordersCSV(){
    const list = await loadOrders();
    const rows = [['ID','Branch','Status','Lines','CreatedAt']];
    for(const o of list){ rows.push([o.id, o.branch, o.status, (o.items?.length||0), formatTs(o.createdAt)]); }
    download('orders.csv', new Blob([toCSV(rows)], {type:'text/csv;charset=utf-8;'}));
  }
  function reportPDF(title, rows){
    const w = window.open('', '_blank');
    w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>${title}</title>
      <style>body{font-family:Arial;padding:16px} table{border-collapse:collapse;width:100%} td,th{border:1px solid #ddd;padding:6px}</style>
      </head><body>`);
    w.document.write(`<h2>${title}</h2><table><thead><tr>${rows[0].map(x=>`<th>${x}</th>`).join('')}</tr></thead><tbody>`);
    for(const r of rows.slice(1)){ w.document.write(`<tr>${r.map(x=>`<td>${x}</td>`).join('')}</tr>`); }
    w.document.write('</tbody></table></body></html>'); w.document.close(); w.focus(); w.print();
  }
  return { ordersCSV, reportPDF };
})();

/* =====================================================================
   MODÃœL: SayÄ±m & Mutabakat Oturumu â€” CanlÄ± SayÄ±m, Fark Analizi
   ===================================================================== */

const CountSession = (()=>{
  let session = null; // {id, startedAt, items: Map(code -> {expected, counted})}

  function start(id){ session = { id: id||('CS-'+Date.now()), startedAt: Date.now(), items: new Map() }; toast('SayÄ±m baÅŸlatÄ±ldÄ±'); return session.id; }
  function addScan(code){ const row = session.items.get(code)||{expected: Inventory.get(code).qty||0, counted:0}; row.counted++; session.items.set(code, row); return row; }
  function setCount(code, val){ const row = session.items.get(code)||{expected:0, counted:0}; row.counted = val; session.items.set(code,row); }
  function diff(){ if(!session) return []; return Array.from(session.items, ([code,row])=>({code, expected:row.expected, counted:row.counted, delta: (row.counted - row.expected)})); }
  function finish(){ const out = diff(); session=null; toast('SayÄ±m tamamlandÄ±'); return out; }
  return { start, addScan, setCount, diff, finish };
})();

/* =====================================================================
   MODÃœL: GÃ¶rev ZamanlayÄ±cÄ± â€” PlanlÄ± Ä°ÅŸler (Temizlik, Sync, Rapor)
   ===================================================================== */

const Scheduler = (()=>{
  const jobs = new Map();
  function every(key, ms, fn){ clear(key); const id=setInterval(fn, ms); jobs.set(key, id); }
  function at8am(key, fn){
    clear(key);
    const now = new Date();
    const next = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 8, 0, 0, 0);
    if(next<=now) next.setDate(next.getDate()+1);
    const wait = next-now;
    const t = setTimeout(()=>{ fn(); every(key, 24*60*60*1000, fn); }, wait);
    jobs.set(key, t);
  }
  function clear(key){ const t=jobs.get(key); if(!t) return; clearTimeout(t); clearInterval(t); jobs.delete(key); }
  return { every, at8am, clear };
})();

// Ã–rnek planlÄ± gÃ¶revler
Scheduler.every('flush', 20000, ()=> flushQueue().catch(()=>{}));
Scheduler.at8am('daily-report', async ()=>{
  const list = await loadOrders();
  const rows = [['ID','Branch','Status','Lines','CreatedAt']];
  for(const o of list){ rows.push([o.id, o.branch, o.status, (o.items?.length||0), formatTs(o.createdAt)]); }
  Exporter.reportPDF('GÃ¼nlÃ¼k SipariÅŸ Raporu', rows);
});

/* =====================================================================
   MODÃœL: Form Validator & Helpers
   ===================================================================== */

const V = {
  required: (v)=> (v!=null && String(v).trim()!==''),
  positiveInt: (v)=> Number.isInteger(v=Number(v)) && v>0,
  max: (n)=>(v)=> Number(v)<=n,
  min: (n)=>(v)=> Number(v)>=n,
};

function ensureNewOrderForm({branch, product, qty}){
  if(!V.required(branch)) throw new Error('Åube zorunlu');
  if(!V.required(product)) throw new Error('ÃœrÃ¼n zorunlu');
  if(!V.positiveInt(qty)) throw new Error('Miktar > 0 olmalÄ±');
}

/* =====================================================================
   MODÃœL: Stres Testi â€” YÃ¼k AltÄ±nda DavranÄ±ÅŸ
   ===================================================================== */

const Stress = (()=>{
  async function burstCreate(n=20){
    for(let i=0;i<n;i++){
      await createOrder({ branch:'Stress', items:[{code:'ST-'+i, name:'Test', aisle:'A-01', quantity:1, picked:0}] });
    }
    toast('Stres: sipariÅŸler eklendi');
  }
  async function randomPick(iter=50){
    const list = await loadOrders(); if(!list.length) return;
    for(let i=0;i<iter;i++){
      const o = list[Math.floor(Math.random()*list.length)];
      if(!(o.items||[]).length) continue;
      const it = o.items[Math.floor(Math.random()*o.items.length)];
      await setPickedQty(o.id, it.id, Math.min((it.picked||0)+1, it.quantity));
    }
    toast('Stres: rastgele pick bitti');
  }
  return { burstCreate, randomPick };
})();

/* =====================================================================
   MODÃœL: GeliÅŸmiÅŸ Hata ToplayÄ±cÄ± â€” UI Ã¼stÃ¼ Log Panel
   ===================================================================== */

const ErrorPanel = (()=>{
  const q = [];
  function push(level, message){ q.push({ts:new Date(), level, message}); if(q.length>100) q.shift(); }
  function view(){
    const w = window.open('', '_blank');
    w.document.write('<pre style="font-family:Consolas,monospace;white-space:pre-wrap">'+ q.map(x=> `[${x.ts.toLocaleTimeString()}] ${x.level.toUpperCase()} ${x.message}`).join('
') +'</pre>');
  }
  // patch loggers
  const _info = logInfo; const _err = logError;
  logInfo = function(msg, data){ push('info', msg); _info(msg, data); };
  logError = function(msg, err){ push('error', msg+': '+(err?.message||err)); _err(msg, err); };
  return { view };
})();

/* =====================================================================
   MODÃœL: UI KÃ¶prÃ¼leri â€” index.html butonlarÄ±nÄ± app.js fonksiyonlarÄ±na baÄŸla
   ===================================================================== */

(function wireIndexButtons(){
  // Orders CSV
  document.getElementById('btnOrdersCSV')?.addEventListener('click', ()=> Exporter.ordersCSV());
  document.getElementById('btnDashCSV')?.addEventListener('click', ()=> Exporter.ordersCSV());

  // Yeni sipariÅŸ dialog (index.html#dlgOrder)
  const dlgOrder = document.getElementById('dlgOrder');
  document.getElementById('btnNewOrder')?.addEventListener('click', ()=> dlgOrder.showModal());
  document.getElementById('dlgSave')?.addEventListener('click', async (e)=>{
    e.preventDefault();
    const branch = document.getElementById('dlgBranch').value.trim();
    const product = document.getElementById('dlgProduct').value.trim();
    const qty = parseInt(document.getElementById('dlgQty').value,10)||0;
    try{
      ensureNewOrderForm({branch, product, qty});
      await createOrder({ branch, items:[{ code: slug(product), name: product, aisle:'A-01', quantity: qty, picked:0 }] });
      dlgOrder.close(); await loadOrders(); toast('SipariÅŸ eklendi');
    }catch(e){ alert(e.message||e); }
  });

  // Labels
  document.getElementById('btnLabelPreview')?.addEventListener('click', ()=>{
    const html = Label.palletLabel({orderId:'SIP-XXXX', branch:'KonyaaltÄ±'}); const w = window.open('','_blank'); w.document.write(html); w.document.close();
  });
  document.getElementById('btnLabelPrint')?.addEventListener('click', ()=> Label.printHTML(Label.palletLabel({orderId:'SIP-XXXX', branch:'KonyaaltÄ±'})) );

  // Reports
  document.getElementById('btnReportExport')?.addEventListener('click', async ()=>{
    const list = await loadOrders(); const rows=[['ID','Branch','Status','Lines','CreatedAt']];
    for(const o of list){ rows.push([o.id,o.branch,o.status,(o.items?.length||0),formatTs(o.createdAt)]); }
    Exporter.reportPDF('SipariÅŸ Raporu', rows);
  });

  // YardÄ±mcÄ±
  document.getElementById('btnRefreshDashboard')?.addEventListener('click', ()=> location.reload());
})();

/* =====================================================================
   MODÃœL: Son DokunuÅŸlar â€” Global Export ve HazÄ±r Mesaj
   ===================================================================== */

Object.assign(window, { URT, WSSync, Label, Exporter, CountSession, Scheduler, V, Stress, ErrorPanel });
logInfo('GeniÅŸletilmiÅŸ kurumsal modÃ¼ller yÃ¼klendi');

