<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Depo Giriş | ProWMS</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }
  </style>
</head>
<body class="min-h-screen bg-slate-100 flex items-center justify-center p-4">
  <div
    class="w-full max-w-md bg-white rounded-2xl shadow-xl border border-slate-200 p-8"
  >
    <!-- Logo / Başlık -->
    <div class="mb-6 text-center">
      <div
        class="mx-auto w-12 h-12 rounded-2xl bg-blue-600 flex items-center justify-center text-white font-extrabold text-xl shadow-lg shadow-blue-500/40"
      >
        D
      </div>
      <h1 class="mt-3 text-2xl font-bold text-slate-900">Depo Giriş</h1>
      <p class="mt-1 text-sm text-slate-500">
        E-posta ve şifreniz ile sisteme giriş yapın.
      </p>
    </div>

    <!-- Giriş Formu -->
    <form id="loginForm" class="space-y-4">
      <div>
        <label
          for="email"
          class="block text-sm font-medium text-slate-700 mb-1"
        >
          E-posta
        </label>
        <input
          type="email"
          id="email"
          required
          autocomplete="username"
          class="w-full px-3 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
          placeholder="ornek@firma.com"
        />
      </div>

      <div>
        <label
          for="password"
          class="block text-sm font-medium text-slate-700 mb-1"
        >
          Şifre
        </label>
        <input
          type="password"
          id="password"
          required
          autocomplete="current-password"
          class="w-full px-3 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
          placeholder="••••••••"
        />
      </div>

      <!-- Hata Mesajı -->
      <p id="loginError" class="text-xs text-red-600 min-h-[1.25rem]"></p>

      <button
        type="submit"
        class="w-full mt-1 inline-flex items-center justify-center px-4 py-2.5 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold rounded-lg shadow-md shadow-blue-500/30 transition"
      >
        Giriş Yap
      </button>
    </form>

    <!-- Alt Bilgi -->
    <div class="mt-6 text-xs text-slate-500">
      <p class="mb-1">
        <strong>Not:</strong> Kullanıcı rolü
        <code class="bg-slate-100 px-1 rounded text-[10px]">
          manager / picker / qc
        </code>
        Firestore’da
        <code class="bg-slate-100 px-1 rounded text-[10px]">
          users/{uid}.role
        </code>
        alanından okunur.
      </p>
      <p class="mt-2 text-[11px] text-slate-400">
        Giriş sonrası rolünüze göre ilgili panele
        (<code>manager.html</code>, <code>picker.html</code>,
        <code>qc.html</code>) yönlendirilirsiniz.
      </p>
    </div>
  </div>

  <!-- Firebase + Login Kodu (TEK DOSYA) -->
  <script type="module">
    // ----------------------------------------------------
    // 1) Firebase importları (CDN)
    // ----------------------------------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      onAuthStateChanged,
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ----------------------------------------------------
    // 2) Firebase Config (BURAYI KENDİ PROJENE GÖRE DOLDUR)
    // ----------------------------------------------------
    const firebaseConfig = {
      apiKey: "BURAYA_API_KEY",
      authDomain: "projen.firebaseapp.com",
      projectId: "projen-id",
      storageBucket: "projen.appspot.com",
      messagingSenderId: "XXXXXXXXXXXX",
      appId: "1:XXXXXXXXXXXX:web:YYYYYYYYYYYYYY",
    };

    // ----------------------------------------------------
    // 3) Firebase başlatma
    // ----------------------------------------------------
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);       // <--- ARTIK TANIMLI
    const db = getFirestore(app);

    const loginForm = document.getElementById("loginForm");
    const loginError = document.getElementById("loginError");

    // ----------------------------------------------------
    // 4) Firestore'dan rol okuma
    // ----------------------------------------------------
    async function getUserRole(uid) {
      const ref = doc(db, "users", uid);
      const snap = await getDoc(ref);

      if (!snap.exists()) {
        throw new Error("Kullanıcı Firestore'da bulunamadı (users/" + uid + ").");
      }
      return snap.data().role || "picker";
    }

    // ----------------------------------------------------
    // 5) Form submit → giriş yap
    // ----------------------------------------------------
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      loginError.textContent = "";

      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();

      if (!email || !password) {
        loginError.textContent = "E-posta ve şifre zorunludur.";
        return;
      }

      try {
        // Firebase Auth ile giriş
        await signInWithEmailAndPassword(auth, email, password);

        const user = auth.currentUser;
        if (!user) {
          loginError.textContent = "Giriş başarısız: kullanıcı okunamadı.";
          return;
        }

        // Rol oku
        const role = await getUserRole(user.uid);

        if (role === "manager") {
          window.location.href = "manager.html";
        } else if (role === "qc") {
          window.location.href = "qc.html";
        } else {
          window.location.href = "picker.html";
        }
      } catch (err) {
        console.error("Giriş hatası:", err);
        loginError.textContent = "Giriş hatası: " + (err.message || err.code || "Bilinmeyen hata");
      }
    });

    // ----------------------------------------------------
    // 6) Zaten login ise direkt yönlendir
    // ----------------------------------------------------
    onAuthStateChanged(auth, async (user) => {
      if (!user) return;
      try {
        const role = await getUserRole(user.uid);
        if (role === "manager") {
          window.location.href = "manager.html";
        } else if (role === "qc") {
          window.location.href = "qc.html";
        } else {
          window.location.href = "picker.html";
        }
      } catch (err) {
        console.error("Oturum rol kontrolü hatası:", err);
      }
    });
  </script>
</body>
</html>
